import React, { useState, useEffect } from 'react';
import { Plus, Download, Eye, Trash2, Edit3, LogOut, BarChart3, Users, TrendingUp, Calendar, UserPlus, Settings, X } from 'lucide-react';

const SalesTracker = () => {
  // Structure des commerciaux avec leurs zones et mots de passe
  const defaultUsers = {
    "admin": { 
      password: "admin123", 
      type: "admin", 
      name: "Administrateur"
    },
    "sarah": { 
      password: "sarah123", 
      type: "commercial", 
      name: "Sarah",
      agence: "Lille", 
      permanences: ["Armenti√®res", "Bousbecques", "Lesquin", "Carvin"] 
    },
    "caroline": { 
      password: "caroline123", 
      type: "commercial", 
      name: "Caroline",
      agence: "Lille", 
      permanences: ["Arras", "B√©thune", "Valenciennes", "La Bass√©e"] 
    },
    "laurence": { 
      password: "laurence123", 
      type: "commercial", 
      name: "Laurence",
      agence: "Lille", 
      permanences: ["Cambrai", "Feignies", "Flers en Escrebieux"] 
    },
    "sophie": { 
      password: "sophie123", 
      type: "commercial", 
      name: "Sophie",
      agence: "Compi√®gne", 
      permanences: ["Chauny", "Laon", "Saint Quentin", "Soissons"] 
    },
    "christelle": { 
      password: "christelle123", 
      type: "commercial", 
      name: "Christelle",
      agence: "Compi√®gne", 
      permanences: ["Beauvais", "Gouvieux", "Mouy", "St Just en chauss√©e"] 
    },
    "aldo": { 
      password: "aldo123", 
      type: "commercial", 
      name: "Aldo",
      agence: "Boves", 
      permanences: [] 
    },
    "celine": { 
      password: "celine123", 
      type: "commercial", 
      name: "C√©line",
      agence: "Boves", 
      permanences: ["Doullens", "Saint Valery", "Albert", "P√©ronne", "Poix de Picardie", "Abbeville"] 
    },
    "july": { 
      password: "july123", 
      type: "commercial", 
      name: "July",
      agence: "Caen", 
      permanences: [] 
    },
    "cedric": { 
      password: "cedric123", 
      type: "commercial", 
      name: "C√©dric",
      agence: "Caen", 
      permanences: ["Cherbourg", "Granville", "Saint L√¥", "Alen√ßon", "Argentan", "Flers"] 
    },
    "messa": { 
      password: "messa123", 
      type: "commercial", 
      name: "Messa",
      agence: "Rouen", 
      permanences: ["√âvreux", "Vernon", "Louviers"] 
    },
    "amandine": { 
      password: "amandine123", 
      type: "commercial", 
      name: "Amandine",
      agence: "Calais", 
      permanences: ["Saint Omer", "Saint Leonard", "Hesdin", "Hazebrouck", "√âtaples"] 
    },
    "annabelle": { 
      password: "annabelle123", 
      type: "commercial", 
      name: "Annabelle",
      agence: "Le Havre", 
      permanences: ["Lisieux", "Yvetot", "Pont Audemer"] 
    }
  };

  const typesVente = ["Face √† face", "T√©l"];
  const origines = ["Prcad", "Rebond Crc", "Client", "Campagne", "Reco", "Visite", "Sant√© sortie de groupe"];
  
  const defaultContrats = [
    "Sant√© sortie de groupe", "Pr√©voyance individuelle", "Protectvia", "Viv√©pargne",
    "Prima Cap obsq Pu", "Prima Cap obsq PP", "Prima Vol obsq Pu", "Prima vol obsq Pu",
    "Certificats Mutualistes", "Viaplus", "Protec territorial", "HPJ", "Terre de vie",
    "Gpa", "Multiprima", "Mutame", "Perte autonomie", "Patrimoine s√©lection"
  ];

  // √âtats
  const [users, setUsers] = useState(defaultUsers);
  const [contrats, setContrats] = useState(defaultContrats);
  const [currentUser, setCurrentUser] = useState(null);
  const [loginForm, setLoginForm] = useState({ username: '', password: '' });
  const [currentView, setCurrentView] = useState('dashboard');
  const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);
  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
  const [ventes, setVentes] = useState([]);
  const [editingId, setEditingId] = useState(null);
  const [showUserForm, setShowUserForm] = useState(false);
  const [showContractForm, setShowContractForm] = useState(false);
  const [editingUser, setEditingUser] = useState(null);
  const [newContract, setNewContract] = useState('');
  
  const [formData, setFormData] = useState({
    commercial: '',
    nom: '',
    prenom: '',
    age: '',
    numeroPersonne: '',
    vente: '',
    rattachement: '',
    origine: '',
    contrat: '',
    dateEffet: '',
    chiffreAffaires: '',
    pna: '',
    jourRdv: ''
  });

  const [newUserForm, setNewUserForm] = useState({
    username: '',
    name: '',
    password: '',
    agence: '',
    permanences: ''
  });

  const [editUserForm, setEditUserForm] = useState({
    permanences: ''
  });

  // Chargement des donn√©es au d√©marrage
  useEffect(() => {
    loadData();
  }, []);

  // Sauvegarde automatique
  useEffect(() => {
    saveData();
  }, [ventes, users, contrats]);

  const saveData = () => {
    try {
      const data = {
        ventes,
        users,
        contrats,
        version: '1.1',
        lastSaved: new Date().toISOString()
      };
      const dataStr = JSON.stringify(data);
      window.salesTrackerData = dataStr;
      console.log('Donn√©es sauvegard√©es automatiquement');
    } catch (error) {
      console.error('Erreur lors de la sauvegarde:', error);
    }
  };

  const loadData = () => {
    try {
      const savedData = window.salesTrackerData;
      if (savedData) {
        const data = JSON.parse(savedData);
        if (data.ventes) {
          setVentes(data.ventes);
        }
        if (data.users) {
          setUsers(data.users);
        }
        if (data.contrats) {
          setContrats(data.contrats);
        }
        console.log('Donn√©es charg√©es depuis la sauvegarde');
      } else {
        console.log('Aucune sauvegarde trouv√©e, utilisation des donn√©es par d√©faut');
      }
    } catch (error) {
      console.error('Erreur lors du chargement:', error);
      console.log('Utilisation des donn√©es par d√©faut');
    }
  };

  const exportAllData = () => {
    const dataToExport = {
      ventes,
      users,
      contrats,
      exportDate: new Date().toISOString(),
      version: '1.1'
    };
    
    const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { 
      type: 'application/json' 
    });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `backup_sales_tracker_${new Date().toISOString().split('T')[0]}.json`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const importData = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const importedData = JSON.parse(e.target.result);
        
        if (importedData.ventes) {
          setVentes(importedData.ventes);
        }
        if (importedData.users) {
          setUsers(importedData.users);
        }
        if (importedData.contrats) {
          setContrats(importedData.contrats);
        }
        
        alert('Donn√©es import√©es avec succ√®s !');
      } catch (error) {
        alert('Erreur lors de l\'import. V√©rifiez le format du fichier.');
        console.error('Erreur import:', error);
      }
    };
    reader.readAsText(file);
    event.target.value = '';
  };

  // Gestion de la connexion
  const handleLogin = () => {
    const user = users[loginForm.username.toLowerCase()];
    if (user && user.password === loginForm.password) {
      setCurrentUser({ ...user, username: loginForm.username.toLowerCase() });
      setLoginForm({ username: '', password: '' });
    } else {
      alert('Nom d\'utilisateur ou mot de passe incorrect');
    }
  };

  const handleLogout = () => {
    setCurrentUser(null);
    setCurrentView('dashboard');
    resetForm();
  };

  const resetForm = () => {
    setFormData({
      commercial: '',
      nom: '',
      prenom: '',
      age: '',
      numeroPersonne: '',
      vente: '',
      rattachement: '',
      origine: '',
      contrat: '',
      dateEffet: '',
      chiffreAffaires: '',
      pna: '',
      jourRdv: ''
    });
    setEditingId(null);
  };

  const handleSubmit = () => {
    // Pour les commerciaux, d√©finir automatiquement leur nom
    const commercial = currentUser.type === 'commercial' ? currentUser.name : formData.commercial;
    
    // Validation des champs obligatoires
    if (!commercial || !formData.nom || !formData.prenom || !formData.vente || 
        !formData.rattachement || !formData.origine || !formData.contrat || 
        !formData.dateEffet || !formData.chiffreAffaires || !formData.pna) {
      alert('Veuillez remplir tous les champs obligatoires (*)');
      return;
    }
    
    const venteFinal = { ...formData, commercial };
    
    if (editingId) {
      setVentes(prevVentes => prevVentes.map(vente => 
        vente.id === editingId 
          ? { ...venteFinal, id: editingId, dateCreation: vente.dateCreation }
          : vente
      ));
      setEditingId(null);
    } else {
      const newVente = {
        ...venteFinal,
        id: Date.now(),
        dateCreation: new Date().toLocaleString('fr-FR')
      };
      setVentes(prevVentes => [...prevVentes, newVente]);
    }
    
    resetForm();
    alert(editingId ? 'Vente modifi√©e avec succ√®s !' : 'Vente ajout√©e avec succ√®s !');
  };

  const handleEdit = (vente) => {
    setFormData({ ...vente });
    setEditingId(vente.id);
    setCurrentView('saisie');
  };

  const handleDelete = (id) => {
    console.log('Tentative de suppression de la vente ID:', id);
    if (window.confirm('√ätes-vous s√ªr de vouloir supprimer cette vente ?')) {
      setVentes(prevVentes => {
        const newVentes = prevVentes.filter(vente => vente.id !== id);
        console.log('Vente supprim√©e, nouvelles ventes:', newVentes.length);
        return newVentes;
      });
      alert('Vente supprim√©e avec succ√®s !');
    }
  };

  const addNewUser = () => {
    if (!newUserForm.username || !newUserForm.name || !newUserForm.password || !newUserForm.agence) {
      alert('Veuillez remplir tous les champs obligatoires');
      return;
    }

    if (users[newUserForm.username.toLowerCase()]) {
      alert('Cet utilisateur existe d√©j√†');
      return;
    }

    const permanencesArray = newUserForm.permanences 
      ? newUserForm.permanences.split(',').map(p => p.trim()).filter(p => p)
      : [];

    const newUser = {
      password: newUserForm.password,
      type: 'commercial',
      name: newUserForm.name,
      agence: newUserForm.agence,
      permanences: permanencesArray
    };

    setUsers(prevUsers => ({
      ...prevUsers,
      [newUserForm.username.toLowerCase()]: newUser
    }));

    setNewUserForm({
      username: '',
      name: '',
      password: '',
      agence: '',
      permanences: ''
    });

    setShowUserForm(false);
    alert('Commercial ajout√© avec succ√®s !');
  };

  // Gestion des contrats
  const addContract = () => {
    if (!newContract.trim()) {
      alert('Veuillez saisir un nom de contrat');
      return;
    }

    if (contrats.includes(newContract.trim())) {
      alert('Ce contrat existe d√©j√†');
      return;
    }

    setContrats(prev => [...prev, newContract.trim()]);
    setNewContract('');
    alert('Contrat ajout√© avec succ√®s !');
  };

  const deleteContract = (contractToDelete) => {
    if (window.confirm(`√ätes-vous s√ªr de vouloir supprimer le contrat "${contractToDelete}" ?`)) {
      // Forcer la mise √† jour en cr√©ant un nouveau tableau
      setContrats(prevContrats => {
        const newContrats = prevContrats.filter(c => c !== contractToDelete);
        console.log('Contrat supprim√©:', contractToDelete);
        console.log('Nouveaux contrats:', newContrats);
        return newContrats;
      });
      alert('Contrat supprim√© avec succ√®s !');
    }
  };

  // Gestion des permanences
  const startEditingUser = (username) => {
    const user = users[username];
    setEditingUser(username);
    setEditUserForm({
      permanences: user.permanences.join(', ')
    });
  };

  const saveUserPermanences = () => {
    if (!editingUser) return;

    const permanencesArray = editUserForm.permanences 
      ? editUserForm.permanences.split(',').map(p => p.trim()).filter(p => p)
      : [];

    setUsers(prevUsers => ({
      ...prevUsers,
      [editingUser]: {
        ...prevUsers[editingUser],
        permanences: permanencesArray
      }
    }));

    setEditingUser(null);
    setEditUserForm({ permanences: '' });
    alert('Permanences mises √† jour avec succ√®s !');
  };

  const cancelEditingUser = () => {
    setEditingUser(null);
    setEditUserForm({ permanences: '' });
  };

  const exportToCSV = () => {
    const ventesToExport = getFilteredVentes();
    if (ventesToExport.length === 0) {
      alert('Aucune vente √† exporter !');
      return;
    }

    const headers = [
      'Commercial', 'Nom', 'Pr√©nom', '√Çge', 'Num√©ro personne', 'Vente', 'Rattachement',
      'Origine', 'Contrat', 'Date effet', 'Chiffre d\'affaires', 'PNA', 'Jour du rdv'
    ];
    
    const csvContent = [
      headers.join(','),
      ...ventesToExport.map(vente => [
        vente.commercial, vente.nom, vente.prenom, vente.age, vente.numeroPersonne,
        vente.vente, vente.rattachement, vente.origine, vente.contrat, vente.dateEffet,
        vente.chiffreAffaires, vente.pna, vente.jourRdv
      ].join(','))
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `ventes_${currentUser?.name || 'toutes'}_${selectedMonth}-${selectedYear}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const getRattachementOptions = () => {
    if (currentUser?.type === 'commercial') {
      const options = [currentUser.agence];
      return [...options, ...currentUser.permanences];
    }
    if (!formData.commercial) return [];
    const user = Object.values(users).find(u => u.name === formData.commercial);
    if (!user || user.type !== 'commercial') return [];
    
    const options = [user.agence];
    return [...options, ...user.permanences];
  };

  const getFilteredVentes = () => {
    let filtered = ventes;
    
    // Filtrer par commercial si pas admin
    if (currentUser?.type === 'commercial') {
      filtered = filtered.filter(vente => vente.commercial === currentUser.name);
    }
    
    // Filtrer par mois/ann√©e
    filtered = filtered.filter(vente => {
      if (!vente.dateEffet) return false;
      const date = new Date(vente.dateEffet);
      return date.getMonth() + 1 === selectedMonth && date.getFullYear() === selectedYear;
    });
    
    return filtered;
  };

  const getStats = () => {
    const ventesFiltered = getFilteredVentes();
    const totalVentes = ventesFiltered.length;
    const totalCA = ventesFiltered.reduce((sum, vente) => sum + (parseFloat(vente.chiffreAffaires) || 0), 0);
    const totalPNA = ventesFiltered.reduce((sum, vente) => sum + (parseFloat(vente.pna) || 0), 0);
    
    const ventesParCommercial = {};
    const telVsFaceAFace = { "T√©l": 0, "Face √† face": 0 };
    const ventesParProduit = {};
    const ventesParOrigine = {};
    const ventesParLieu = {};
    
    ventesFiltered.forEach(vente => {
      // Par commercial
      if (!ventesParCommercial[vente.commercial]) {
        ventesParCommercial[vente.commercial] = { ventes: 0, ca: 0, pna: 0 };
      }
      ventesParCommercial[vente.commercial].ventes++;
      ventesParCommercial[vente.commercial].ca += parseFloat(vente.chiffreAffaires) || 0;
      ventesParCommercial[vente.commercial].pna += parseFloat(vente.pna) || 0;
      
      // T√©l vs Face √† face
      if (vente.vente) {
        telVsFaceAFace[vente.vente]++;
      }
      
      // Par produit
      if (vente.contrat && vente.contrat.trim()) {
        if (!ventesParProduit[vente.contrat]) {
          ventesParProduit[vente.contrat] = 0;
        }
        ventesParProduit[vente.contrat]++;
      }
      
      // Par origine
      if (vente.origine && vente.origine.trim()) {
        if (!ventesParOrigine[vente.origine]) {
          ventesParOrigine[vente.origine] = 0;
        }
        ventesParOrigine[vente.origine]++;
      }
      
      // Par lieu (avec noms des permanences)
      if (vente.rattachement && vente.rattachement.trim()) {
        if (!ventesParLieu[vente.rattachement]) {
          ventesParLieu[vente.rattachement] = 0;
        }
        ventesParLieu[vente.rattachement]++;
      }
    });

    return { 
      totalVentes, 
      totalCA, 
      totalPNA, 
      ventesParCommercial, 
      telVsFaceAFace, 
      ventesParProduit,
      ventesParOrigine,
      ventesParLieu
    };
  };

  const stats = getStats();

  // Page de connexion
  if (!currentUser) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
          <h1 className="text-2xl font-bold text-center mb-6 text-gray-900">
            Suivi des Ventes - Connexion
          </h1>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Nom d'utilisateur
              </label>
              <input
                type="text"
                value={loginForm.username}
                onChange={(e) => setLoginForm({...loginForm, username: e.target.value})}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Votre nom d'utilisateur"
                onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Mot de passe
              </label>
              <input
                type="password"
                value={loginForm.password}
                onChange={(e) => setLoginForm({...loginForm, password: e.target.value})}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Votre mot de passe"
                onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
              />
            </div>
            <button
              onClick={handleLogin}
              className="w-full bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors"
            >
              Se connecter
            </button>
          </div>
          
          <div className="mt-8 p-4 bg-gray-50 rounded-lg">
            <h3 className="font-medium text-gray-900 mb-2">Comptes de test :</h3>
            <div className="text-sm text-gray-600 space-y-1">
              <div><strong>Admin:</strong> admin / admin123</div>
              <div><strong>Commercial:</strong> sarah / sarah123</div>
              <div className="text-xs text-gray-500 mt-2">
                (Remplacez sarah par le pr√©nom en minuscules + 123)
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <div className="bg-white shadow-sm border-b">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex justify-between items-center">
            <div>
              <h1 className="text-2xl font-bold text-gray-900">Suivi des Ventes - Assurance</h1>
              <p className="text-sm text-gray-600">
                Connect√© en tant que : <span className="font-medium">{currentUser.name}</span>
                {currentUser.type === 'commercial' && ` (${currentUser.agence})`}
                <span className="text-green-600 ml-2">‚úì Sauvegarde automatique</span>
              </p>
            </div>
            
            <div className="flex items-center gap-4">
              {/* S√©lecteur de p√©riode */}
              <div className="flex items-center gap-2">
                <Calendar className="w-4 h-4 text-gray-500" />
                <select
                  value={selectedMonth}
                  onChange={(e) => setSelectedMonth(parseInt(e.target.value))}
                  className="px-2 py-1 border border-gray-300 rounded text-sm"
                >
                  {Array.from({length: 12}, (_, i) => (
                    <option key={i+1} value={i+1}>
                      {new Date(0, i).toLocaleDateString('fr-FR', { month: 'long' })}
                    </option>
                  ))}
                </select>
                <select
                  value={selectedYear}
                  onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                  className="px-2 py-1 border border-gray-300 rounded text-sm"
                >
                  {Array.from({length: 5}, (_, i) => (
                    <option key={2023+i} value={2023+i}>{2023+i}</option>
                  ))}
                </select>
              </div>
              
              <div className="flex gap-2">
                <button
                  onClick={() => setCurrentView('dashboard')}
                  className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                    currentView === 'dashboard' 
                      ? 'bg-blue-600 text-white' 
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  <BarChart3 className="w-4 h-4 inline mr-2" />
                  Dashboard
                </button>
                {currentUser.type === 'commercial' && (
                  <>
                    <button
                      onClick={() => setCurrentView('saisie')}
                      className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                        currentView === 'saisie' 
                          ? 'bg-blue-600 text-white' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      <Plus className="w-4 h-4 inline mr-2" />
                      Nouvelle vente
                    </button>
                    <button
                      onClick={() => setCurrentView('liste')}
                      className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                        currentView === 'liste' 
                          ? 'bg-blue-600 text-white' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      <Eye className="w-4 h-4 inline mr-2" />
                      Mes ventes ({getFilteredVentes().length})
                    </button>
                  </>
                )}
                {currentUser.type === 'admin' && (
                  <>
                    <button
                      onClick={() => setCurrentView('liste')}
                      className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                        currentView === 'liste' 
                          ? 'bg-blue-600 text-white' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      <Eye className="w-4 h-4 inline mr-2" />
                      Toutes les ventes ({getFilteredVentes().length})
                    </button>
                    <button
                      onClick={() => setCurrentView('gestion')}
                      className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                        currentView === 'gestion' 
                          ? 'bg-blue-600 text-white' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      <Settings className="w-4 h-4 inline mr-2" />
                      Gestion
                    </button>
                  </>
                )}
                <button
                  onClick={exportToCSV}
                  className="px-3 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors"
                >
                  <Download className="w-4 h-4 inline mr-2" />
                  Export CSV
                </button>
                <button
                  onClick={handleLogout}
                  className="px-3 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 transition-colors"
                >
                  <LogOut className="w-4 h-4 inline mr-2" />
                  D√©connexion
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 py-6">
        {/* Gestion des utilisateurs et param√®tres (Admin seulement) */}
        {currentView === 'gestion' && currentUser.type === 'admin' && (
          <div className="space-y-6">
            {/* Gestion des donn√©es */}
            <div className="bg-white rounded-lg shadow-sm p-6">
              <h2 className="text-xl font-semibold mb-4">Gestion des Donn√©es</h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button
                  onClick={exportAllData}
                  className="px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors"
                >
                  <Download className="w-4 h-4 inline mr-2" />
                  Backup Complet
                </button>
                <label className="px-4 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors cursor-pointer text-center">
                  <input
                    type="file"
                    accept=".json"
                    onChange={importData}
                    className="hidden"
                  />
                  üìÅ Importer Backup
                </label>
                <button
                  onClick={() => setShowUserForm(!showUserForm)}
                  className="px-4 py-3 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition-colors"
                >
                  <UserPlus className="w-4 h-4 inline mr-2" />
                  Ajouter Commercial
                </button>
              </div>
            </div>

            {/* Gestion des contrats */}
            <div className="bg-white rounded-lg shadow-sm p-6">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-semibold">Gestion des Types de Contrats</h3>
                <button
                  onClick={() => setShowContractForm(!showContractForm)}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors"
                >
                  <Plus className="w-4 h-4 inline mr-2" />
                  Ajouter un contrat
                </button>
              </div>
              
              {showContractForm && (
                <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                  <div className="flex gap-3">
                    <input
                      type="text"
                      value={newContract}
                      onChange={(e) => setNewContract(e.target.value)}
                      placeholder="Nom du nouveau contrat"
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg"
                      onKeyPress={(e) => e.key === 'Enter' && addContract()}
                    />
                    <button
                      onClick={addContract}
                      className="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors"
                    >
                      Ajouter
                    </button>
                    <button
                      onClick={() => {setShowContractForm(false); setNewContract('');}}
                      className="px-4 py-2 bg-gray-500 text-white rounded-lg font-medium hover:bg-gray-600 transition-colors"
                    >
                      Annuler
                    </button>
                  </div>
                </div>
              )}

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                {contrats.map((contrat, index) => (
                  <div key={`contract-${index}-${contrat}`} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span className="text-sm text-gray-900 flex-1">{contrat}</span>
                    <button
                      type="button"
                      onClick={(e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Tentative de suppression du contrat:', contrat);
                        deleteContract(contrat);
                      }}
                      className="p-1 text-red-600 hover:bg-red-50 rounded transition-colors flex-shrink-0 ml-2"
                      title="Supprimer ce contrat"
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                  </div>
                ))}
              </div>
              {contrats.length === 0 && (
                <p className="text-gray-500 text-center py-8">Aucun contrat configur√©</p>
              )}
            </div>

            {showUserForm && (
              <div className="bg-white rounded-lg shadow-sm p-6">
                <h3 className="text-lg font-semibold mb-4">Ajouter un nouveau commercial</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Nom d'utilisateur *
                    </label>
                    <input
                      type="text"
                      value={newUserForm.username}
                      onChange={(e) => setNewUserForm({...newUserForm, username: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      placeholder="Ex: marie"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Nom complet *
                    </label>
                    <input
                      type="text"
                      value={newUserForm.name}
                      onChange={(e) => setNewUserForm({...newUserForm, name: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      placeholder="Ex: Marie Dupont"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Mot de passe *
                    </label>
                    <input
                      type="text"
                      value={newUserForm.password}
                      onChange={(e) => setNewUserForm({...newUserForm, password: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      placeholder="Ex: marie123"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Agence *
                    </label>
                    <input
                      type="text"
                      value={newUserForm.agence}
                      onChange={(e) => setNewUserForm({...newUserForm, agence: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      placeholder="Ex: Lille"
                    />
                  </div>
                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Permanences (s√©par√©es par des virgules)
                    </label>
                    <input
                      type="text"
                      value={newUserForm.permanences}
                      onChange={(e) => setNewUserForm({...newUserForm, permanences: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      placeholder="Ex: Arras, B√©thune, Valenciennes"
                    />
                  </div>
                </div>
                <div className="flex gap-3 mt-4">
                  <button
                    onClick={addNewUser}
                    className="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors"
                  >
                    Ajouter le commercial
                  </button>
                  <button
                    onClick={() => setShowUserForm(false)}
                    className="px-4 py-2 bg-gray-500 text-white rounded-lg font-medium hover:bg-gray-600 transition-colors"
                  >
                    Annuler
                  </button>
                </div>
              </div>
            )}

            {/* Liste des commerciaux avec gestion des permanences */}
            <div className="bg-white rounded-lg shadow-sm p-6">
              <h3 className="text-lg font-semibold mb-4">Gestion des Commerciaux et Permanences</h3>
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-900">Nom</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-900">Username</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-900">Agence</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-900">Permanences</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-900">Ventes Total</th>
                      <th className="px-4 py-3 text-center text-sm font-medium text-gray-900">Actions</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {Object.entries(users)
                      .filter(([, user]) => user.type === 'commercial')
                      .map(([username, user]) => {
                        const userVentes = ventes.filter(v => v.commercial === user.name);
                        const isEditing = editingUser === username;
                        
                        return (
                          <tr key={username} className="hover:bg-gray-50">
                            <td className="px-4 py-3 text-sm text-gray-900">{user.name}</td>
                            <td className="px-4 py-3 text-sm text-gray-600">{username}</td>
                            <td className="px-4 py-3 text-sm text-gray-900">{user.agence}</td>
                            <td className="px-4 py-3 text-sm text-gray-600">
                              {isEditing ? (
                                <div className="flex gap-2">
                                  <input
                                    type="text"
                                    value={editUserForm.permanences}
                                    onChange={(e) => setEditUserForm({permanences: e.target.value})}
                                    className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                                    placeholder="S√©parez par des virgules"
                                  />
                                  <button
                                    onClick={saveUserPermanences}
                                    className="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700"
                                  >
                                    ‚úì
                                  </button>
                                  <button
                                    onClick={cancelEditingUser}
                                    className="px-2 py-1 bg-gray-500 text-white rounded text-xs hover:bg-gray-600"
                                  >
                                    ‚úï
                                  </button>
                                </div>
                              ) : (
                                <div className="flex justify-between items-center">
                                  <span>
                                    {user.permanences.length > 0 ? user.permanences.join(', ') : 'Aucune'}
                                  </span>
                                  <button
                                    onClick={() => startEditingUser(username)}
                                    className="ml-2 p-1 text-blue-600 hover:bg-blue-50 rounded"
                                    title="Modifier les permanences"
                                  >
                                    <Edit3 className="w-3 h-3" />
                                  </button>
                                </div>
                              )}
                            </td>
                            <td className="px-4 py-3 text-sm font-medium text-blue-600">{userVentes.length}</td>
                            <td className="px-4 py-3 text-center">
                              {!isEditing && (
                                <button
                                  onClick={() => startEditingUser(username)}
                                  className="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 transition-colors"
                                >
                                  Modifier permanences
                                </button>
                              )}
                            </td>
                          </tr>
                        );
                      })}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}

        {/* Dashboard */}
        {currentView === 'dashboard' && (
          <div className="space-y-6">
            {/* Statistiques principales */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div className="bg-white p-4 rounded-lg shadow-sm">
                <div className="text-sm text-gray-600">Total ventes</div>
                <div className="text-2xl font-bold text-blue-600">{stats.totalVentes}</div>
              </div>
              <div className="bg-white p-4 rounded-lg shadow-sm">
                <div className="text-sm text-gray-600">CA Total</div>
                <div className="text-2xl font-bold text-green-600">{stats.totalCA.toFixed(2)}‚Ç¨</div>
              </div>
              <div className="bg-white p-4 rounded-lg shadow-sm">
                <div className="text-sm text-gray-600">PNA Total</div>
                <div className="text-2xl font-bold text-purple-600">{stats.totalPNA.toFixed(2)}‚Ç¨</div>
              </div>
              <div className="bg-white p-4 rounded-lg shadow-sm">
                <div className="text-sm text-gray-600">CA Moyen</div>
                <div className="text-2xl font-bold text-orange-600">
                  {stats.totalVentes > 0 ? (stats.totalCA / stats.totalVentes).toFixed(2) : '0'}‚Ç¨
                </div>
              </div>
            </div>

            {/* Stats d√©taill√©es */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* T√©l vs Face √† face */}
              <div className="bg-white p-6 rounded-lg shadow-sm">
                <h3 className="text-lg font-semibold mb-4">R√©partition T√©l vs Face √† face</h3>
                <div className="space-y-3">
                  {Object.entries(stats.telVsFaceAFace).map(([type, count]) => {
                    const percentage = stats.totalVentes > 0 ? (count / stats.totalVentes * 100).toFixed(1) : 0;
                    return (
                      <div key={type}>
                        <div className="flex justify-between text-sm">
                          <span>{type}</span>
                          <span>{count} ventes ({percentage}%)</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                          <div 
                            className={`h-2 rounded-full ${type === 'T√©l' ? 'bg-blue-500' : 'bg-green-500'}`}
                            style={{ width: `${percentage}%` }}
                          ></div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* Performance par Origine */}
              <div className="bg-white p-6 rounded-lg shadow-sm">
                <h3 className="text-lg font-semibold mb-4">R√©partition par Origine</h3>
                <div className="space-y-3">
                  {Object.entries(stats.ventesParOrigine)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .map(([origine, count]) => {
                    const percentage = stats.totalVentes > 0 ? (count / stats.totalVentes * 100).toFixed(1) : 0;
                    return (
                      <div key={origine}>
                        <div className="flex justify-between text-sm">
                          <span>{origine}</span>
                          <span>{count} ventes ({percentage}%)</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                          <div 
                            className="h-2 rounded-full bg-purple-500"
                            style={{ width: `${percentage}%` }}
                          ></div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>

            {/* R√©partition par lieux (Agences et Permanences) */}
            <div className="bg-white p-6 rounded-lg shadow-sm">
              <h3 className="text-lg font-semibold mb-4">Performance par Lieu (Agences & Permanences)</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {Object.entries(stats.ventesParLieu)
                  .sort(([,a], [,b]) => b - a)
                  .map(([lieu, count]) => {
                  const percentage = stats.totalVentes > 0 ? (count / stats.totalVentes * 100).toFixed(1) : 0;
                  // D√©terminer si c'est une agence ou une permanence
                  const isAgence = Object.values(users).some(user => 
                    user.type === 'commercial' && user.agence === lieu
                  );
                  return (
                    <div key={lieu} className="p-3 bg-gray-50 rounded-lg">
                      <div className="text-sm font-medium text-gray-900 mb-1">
                        {lieu}
                        <span className={`ml-2 px-2 py-0.5 text-xs rounded-full ${
                          isAgence ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'
                        }`}>
                          {isAgence ? 'Agence' : 'Permanence'}
                        </span>
                      </div>
                      <div className="text-lg font-bold text-gray-900">{count} ventes</div>
                      <div className="text-sm text-gray-600">{percentage}% du total</div>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Performance par commercial (Admin seulement) */}
            {currentUser.type === 'admin' && (
              <div className="bg-white p-6 rounded-lg shadow-sm">
                <h3 className="text-lg font-semibold mb-4">Performance par Commercial</h3>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="border-b">
                        <th className="text-left py-2">Commercial</th>
                        <th className="text-right py-2">Ventes</th>
                        <th className="text-right py-2">CA Total</th>
                        <th className="text-right py-2">PNA Total</th>
                        <th className="text-right py-2">CA Moyen</th>
                      </tr>
                    </thead>
                    <tbody>
                      {Object.entries(stats.ventesParCommercial)
                        .sort(([,a], [,b]) => b.ventes - a.ventes)
                        .map(([commercial, data]) => (
                        <tr key={commercial} className="border-b hover:bg-gray-50">
                          <td className="py-2 font-medium">{commercial}</td>
                          <td className="text-right py-2">{data.ventes}</td>
                          <td className="text-right py-2 text-green-600">{data.ca.toFixed(2)}‚Ç¨</td>
                          <td className="text-right py-2 text-purple-600">{data.pna.toFixed(2)}‚Ç¨</td>
                          <td className="text-right py-2">{data.ventes > 0 ? (data.ca / data.ventes).toFixed(2) : '0'}‚Ç¨</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* Top produits */}
            <div className="bg-white p-6 rounded-lg shadow-sm">
              <h3 className="text-lg font-semibold mb-4">Performance par Produit</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {Object.entries(stats.ventesParProduit)
                  .sort(([,a], [,b]) => b - a)
                  .slice(0, 9)
                  .map(([produit, count]) => {
                  const percentage = stats.totalVentes > 0 ? (count / stats.totalVentes * 100).toFixed(1) : 0;
                  return (
                    <div key={produit} className="p-3 bg-gray-50 rounded-lg">
                      <div className="text-sm font-medium text-gray-900 mb-1">{produit}</div>
                      <div className="text-lg font-bold text-blue-600">{count} ventes</div>
                      <div className="text-sm text-gray-600">{percentage}% du total</div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}

        {/* Formulaire de saisie */}
        {currentView === 'saisie' && currentUser.type === 'commercial' && (
          <div className="bg-white rounded-lg shadow-sm p-6">
            <h2 className="text-xl font-semibold mb-6">
              {editingId ? 'Modifier la vente' : 'Nouvelle vente'}
            </h2>
            
            <div className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {/* Commercial (Admin seulement) */}
                {currentUser.type === 'admin' && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Commercial *
                    </label>
                    <select
                      value={formData.commercial}
                      onChange={(e) => setFormData({...formData, commercial: e.target.value, rattachement: ''})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                      <option value="">S√©lectionner un commercial</option>
                      {Object.values(users)
                        .filter(user => user.type === 'commercial')
                        .map(user => (
                        <option key={user.name} value={user.name}>{user.name}</option>
                      ))}
                    </select>
                  </div>
                )}

                {/* Nom */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Nom *
                  </label>
                  <input
                    type="text"
                    value={formData.nom}
                    onChange={(e) => setFormData({...formData, nom: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>

                {/* Pr√©nom */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Pr√©nom *
                  </label>
                  <input
                    type="text"
                    value={formData.prenom}
                    onChange={(e) => setFormData({...formData, prenom: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>

                {/* √Çge */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    √Çge
                  </label>
                  <input
                    type="number"
                    value={formData.age}
                    onChange={(e) => setFormData({...formData, age: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>

                {/* Num√©ro personne */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Num√©ro personne
                  </label>
                  <input
                    type="text"
                    value={formData.numeroPersonne}
                    onChange={(e) => setFormData({...formData, numeroPersonne: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>

                {/* Type de vente */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Type de vente *
                  </label>
                  <select
                    value={formData.vente}
                    onChange={(e) => setFormData({...formData, vente: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="">S√©lectionner</option>
                    {typesVente.map(type => (
                      <option key={type} value={type}>{type}</option>
                    ))}
                  </select>
                </div>

                {/* Rattachement */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Rattachement *
                  </label>
                  <select
                    value={formData.rattachement}
                    onChange={(e) => setFormData({...formData, rattachement: e.target.value})}
                    disabled={currentUser.type === 'admin' && !formData.commercial}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100"
                  >
                    <option value="">S√©lectionner</option>
                    {getRattachementOptions().map(option => (
                      <option key={option} value={option}>{option}</option>
                    ))}
                  </select>
                </div>

                {/* Origine */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Origine *
                  </label>
                  <select
                    value={formData.origine}
                    onChange={(e) => setFormData({...formData, origine: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="">S√©lectionner</option>
                    {origines.map(origine => (
                      <option key={origine} value={origine}>{origine}</option>
                    ))}
                  </select>
                </div>

                {/* Contrat */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Contrat *
                  </label>
                  <select
                    value={formData.contrat}
                    onChange={(e) => setFormData({...formData, contrat: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="">S√©lectionner</option>
                    {contrats.map(contrat => (
                      <option key={contrat} value={contrat}>{contrat}</option>
                    ))}
                  </select>
                </div>

                {/* Date effet */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Date effet *
                  </label>
                  <input
                    type="date"
                    value={formData.dateEffet}
                    onChange={(e) => setFormData({...formData, dateEffet: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>

                {/* Chiffre d'affaires */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Chiffre d'affaires (‚Ç¨) *
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    value={formData.chiffreAffaires}
                    onChange={(e) => setFormData({...formData, chiffreAffaires: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>

                {/* PNA */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    PNA (‚Ç¨) *
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    value={formData.pna}
                    onChange={(e) => setFormData({...formData, pna: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>

                {/* Jour du RDV */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Jour du RDV
                  </label>
                  <input
                    type="date"
                    value={formData.jourRdv}
                    onChange={(e) => setFormData({...formData, jourRdv: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
              </div>

              <div className="flex gap-3 pt-4">
                <button
                  type="button"
                  onClick={handleSubmit}
                  className="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors"
                >
                  {editingId ? 'Modifier la vente' : 'Enregistrer la vente'}
                </button>
                {editingId && (
                  <button
                    type="button"
                    onClick={resetForm}
                    className="px-6 py-2 bg-gray-500 text-white rounded-lg font-medium hover:bg-gray-600 transition-colors"
                  >
                    Annuler
                  </button>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Liste des ventes */}
        {currentView === 'liste' && (
          <div className="bg-white rounded-lg shadow-sm">
            <div className="p-6 border-b">
              <h2 className="text-xl font-semibold">
                {currentUser.type === 'commercial' ? 'Mes ventes' : 'Liste des ventes'} 
                ({getFilteredVentes().length})
              </h2>
              <p className="text-sm text-gray-600 mt-1">
                P√©riode : {new Date(0, selectedMonth - 1).toLocaleDateString('fr-FR', { month: 'long' })} {selectedYear}
              </p>
            </div>
            
            {getFilteredVentes().length === 0 ? (
              <div className="p-8 text-center text-gray-500">
                <div className="text-lg mb-2">Aucune vente pour cette p√©riode</div>
                <div className="text-sm">Cliquez sur "Nouvelle vente" pour commencer</div>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      {currentUser.type === 'admin' && (
                        <th className="px-4 py-3 text-left text-sm font-medium text-gray-900">Commercial</th>
                      )}
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-900">Client</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-900">Contrat</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-900">Type</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-900">Rattachement</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-900">CA (‚Ç¨)</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-900">PNA (‚Ç¨)</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-900">Date effet</th>
                      <th className="px-4 py-3 text-right text-sm font-medium text-gray-900">Actions</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {getFilteredVentes().map((vente) => (
                      <tr key={`vente-${vente.id}`} className="hover:bg-gray-50">
                        {currentUser.type === 'admin' && (
                          <td className="px-4 py-3 text-sm font-medium text-gray-900">{vente.commercial}</td>
                        )}
                        <td className="px-4 py-3 text-sm text-gray-900">{vente.nom} {vente.prenom}</td>
                        <td className="px-4 py-3 text-sm text-gray-900">{vente.contrat}</td>
                        <td className="px-4 py-3 text-sm text-gray-900">
                          <span className={`px-2 py-1 rounded-full text-xs ${
                            vente.vente === 'T√©l' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'
                          }`}>
                            {vente.vente}
                          </span>
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-900">{vente.rattachement}</td>
                        <td className="px-4 py-3 text-sm font-medium text-green-600">
                          {parseFloat(vente.chiffreAffaires || 0).toFixed(2)}
                        </td>
                        <td className="px-4 py-3 text-sm font-medium text-purple-600">
                          {parseFloat(vente.pna || 0).toFixed(2)}
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-900">{vente.dateEffet}</td>
                        <td className="px-4 py-3 text-right">
                          <div className="flex justify-end gap-2">
                            {(currentUser.type === 'admin' || vente.commercial === currentUser.name) && (
                              <>
                                <button
                                  type="button"
                                  onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    handleEdit(vente);
                                  }}
                                  className="p-1 text-blue-600 hover:bg-blue-50 rounded"
                                  title="Modifier"
                                >
                                  <Edit3 className="w-4 h-4" />
                                </button>
                                <button
                                  type="button"
                                  onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    console.log('Clic suppression vente:', vente.id);
                                    handleDelete(vente.id);
                                  }}
                                  className="p-1 text-red-600 hover:bg-red-50 rounded"
                                  title="Supprimer"
                                >
                                  <Trash2 className="w-4 h-4" />
                                </button>
                              </>
                            )}
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

export default SalesTracker;
