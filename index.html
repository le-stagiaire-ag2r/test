<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi des Ventes - Assurance</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #111827;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .nav-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn-success {
            background: #059669;
            color: white;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .btn.active {
            background: #2563eb;
            color: white;
        }
        
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .form-input,
        .form-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }
        
        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .table th {
            background: #f9fafb;
            font-weight: 600;
            font-size: 0.875rem;
            color: #374151;
        }
        
        .table tr:hover {
            background: #f9fafb;
        }
        
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .login-card {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .login-title {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1.5rem;
            color: #1f2937;
        }
        
        .form-space {
            margin-bottom: 1rem;
        }
        
        .test-accounts {
            margin-top: 2rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 0.5rem;
        }
        
        .test-accounts h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }
        
        .test-accounts div {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 0.5rem;
            background: #e5e7eb;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 0.25rem;
            transition: width 0.3s ease;
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-blue {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge-green {
            background: #d1fae5;
            color: #065f46;
        }
        
        .hidden {
            display: none;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-gray {
            color: #6b7280;
        }
        
        .mb-4 {
            margin-bottom: 1rem;
        }
        
        .icon {
            width: 1rem;
            height: 1rem;
            display: inline-block;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
            
            .nav-buttons {
                justify-content: center;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- L'application sera injectée ici -->
    </div>

    <script>
        // Données par défaut
        const defaultUsers = {
            "admin": { 
                password: "admin123", 
                type: "admin", 
                name: "Administrateur"
            },
            "sarah": { 
                password: "sarah123", 
                type: "commercial", 
                name: "Sarah",
                agence: "Lille", 
                permanences: ["Armentières", "Bousbecques", "Lesquin", "Carvin"] 
            },
            "caroline": { 
                password: "caroline123", 
                type: "commercial", 
                name: "Caroline",
                agence: "Lille", 
                permanences: ["Arras", "Béthune", "Valenciennes", "La Bassée"] 
            }
        };

        const typesVente = ["Face à face", "Tél"];
        const origines = ["Prcad", "Rebond Crc", "Client", "Campagne", "Reco", "Visite", "Santé sortie de groupe"];
        const defaultContrats = [
            "Santé sortie de groupe", "Prévoyance individuelle", "Protectvia", "Vivépargne",
            "Prima Cap obsq Pu", "Prima Cap obsq PP", "Prima Vol obsq Pu", "Prima vol obsq Pu",
            "Certificats Mutualistes", "Viaplus", "Protec territorial", "HPJ", "Terre de vie"
        ];

        // État de l'application
        let appState = {
            users: {...defaultUsers},
            contrats: [...defaultContrats],
            currentUser: null,
            currentView: 'dashboard',
            selectedMonth: new Date().getMonth() + 1,
            selectedYear: new Date().getFullYear(),
            ventes: [],
            editingId: null,
            formData: {
                commercial: '',
                nom: '',
                prenom: '',
                age: '',
                numeroPersonne: '',
                vente: '',
                rattachement: '',
                origine: '',
                contrat: '',
                dateEffet: '',
                chiffreAffaires: '',
                pna: '',
                jourRdv: ''
            }
        };

        // Fonctions utilitaires
        function saveData() {
            try {
                const data = {
                    ventes: appState.ventes,
                    users: appState.users,
                    contrats: appState.contrats
                };
                localStorage.setItem('salesTrackerData', JSON.stringify(data));
            } catch (error) {
                console.error('Erreur de sauvegarde:', error);
            }
        }

        function loadData() {
            try {
                const savedData = localStorage.getItem('salesTrackerData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.ventes) appState.ventes = data.ventes;
                    if (data.users) appState.users = data.users;
                    if (data.contrats) appState.contrats = data.contrats;
                }
            } catch (error) {
                console.error('Erreur de chargement:', error);
            }
        }

        function getRattachementOptions() {
            if (appState.currentUser?.type === 'commercial') {
                return [appState.currentUser.agence, ...appState.currentUser.permanences];
            }
            if (!appState.formData.commercial) return [];
            const user = Object.values(appState.users).find(u => u.name === appState.formData.commercial);
            if (!user || user.type !== 'commercial') return [];
            return [user.agence, ...user.permanences];
        }

        function getFilteredVentes() {
            let filtered = appState.ventes;
            
            if (appState.currentUser?.type === 'commercial') {
                filtered = filtered.filter(v => v.commercial === appState.currentUser.name);
            }
            
            filtered = filtered.filter(v => {
                if (!v.dateEffet) return false;
                const date = new Date(v.dateEffet);
                return date.getMonth() + 1 === appState.selectedMonth && date.getFullYear() === appState.selectedYear;
            });
            
            return filtered;
        }

        function getStats() {
            const ventesFiltered = getFilteredVentes();
            const totalVentes = ventesFiltered.length;
            const totalCA = ventesFiltered.reduce((sum, v) => sum + (parseFloat(v.chiffreAffaires) || 0), 0);
            const totalPNA = ventesFiltered.reduce((sum, v) => sum + (parseFloat(v.pna) || 0), 0);
            
            const telVsFaceAFace = { "Tél": 0, "Face à face": 0 };
            ventesFiltered.forEach(v => {
                if (v.vente) telVsFaceAFace[v.vente]++;
            });
            
            return { totalVentes, totalCA, totalPNA, telVsFaceAFace };
        }

        // Fonctions d'action
        function handleLogin() {
            const username = document.getElementById('username').value.toLowerCase();
            const password = document.getElementById('password').value;
            
            const user = appState.users[username];
            if (user && user.password === password) {
                appState.currentUser = { ...user, username };
                render();
            } else {
                alert('Nom d\'utilisateur ou mot de passe incorrect');
            }
        }

        function handleLogout() {
            appState.currentUser = null;
            appState.currentView = 'dashboard';
            resetForm();
            render();
        }

        function resetForm() {
            appState.formData = {
                commercial: '',
                nom: '',
                prenom: '',
                age: '',
                numeroPersonne: '',
                vente: '',
                rattachement: '',
                origine: '',
                contrat: '',
                dateEffet: '',
                chiffreAffaires: '',
                pna: '',
                jourRdv: ''
            };
            appState.editingId = null;
        }

        function handleSubmit() {
            const commercial = appState.currentUser.type === 'commercial' ? appState.currentUser.name : appState.formData.commercial;
            
            if (!commercial || !appState.formData.nom || !appState.formData.prenom || !appState.formData.vente || 
                !appState.formData.rattachement || !appState.formData.origine || !appState.formData.contrat || 
                !appState.formData.dateEffet || !appState.formData.chiffreAffaires || !appState.formData.pna) {
                alert('Veuillez remplir tous les champs obligatoires (*)');
                return;
            }
            
            const venteFinal = { ...appState.formData, commercial };
            
            if (appState.editingId) {
                appState.ventes = appState.ventes.map(v => 
                    v.id === appState.editingId ? { ...venteFinal, id: appState.editingId, dateCreation: v.dateCreation } : v
                );
            } else {
                const newVente = {
                    ...venteFinal,
                    id: Date.now(),
                    dateCreation: new Date().toLocaleString('fr-FR')
                };
                appState.ventes.push(newVente);
            }
            
            resetForm();
            saveData();
            alert(appState.editingId ? 'Vente modifiée !' : 'Vente ajoutée !');
            render();
        }

        function handleEdit(vente) {
            appState.formData = { ...vente };
            appState.editingId = vente.id;
            appState.currentView = 'saisie';
            render();
        }

        function handleDelete(id) {
            if (confirm('Supprimer cette vente ?')) {
                appState.ventes = appState.ventes.filter(v => v.id !== id);
                saveData();
                alert('Vente supprimée !');
                render();
            }
        }

        function setView(view) {
            appState.currentView = view;
            if (view !== 'saisie') {
                resetForm();
            }
            render();
        }

        function updateFormField(field, value) {
            appState.formData[field] = value;
            if (field === 'commercial') {
                appState.formData.rattachement = '';
            }
        }

        // Fonction de rendu
        function render() {
            const app = document.getElementById('app');
            
            if (!appState.currentUser) {
                app.innerHTML = renderLogin();
                return;
            }
            
            app.innerHTML = `
                ${renderHeader()}
                <div class="container" style="padding-top: 1.5rem;">
                    ${appState.currentView === 'dashboard' ? renderDashboard() : ''}
                    ${appState.currentView === 'saisie' ? renderSaisie() : ''}
                    ${appState.currentView === 'liste' ? renderListe() : ''}
                    ${appState.currentView === 'gestion' ? renderGestion() : ''}
                </div>
            `;
        }

        function renderLogin() {
            return `
                <div class="login-container">
                    <div class="login-card">
                        <h1 class="login-title">Suivi des Ventes - Connexion</h1>
                        <form onsubmit="event.preventDefault(); handleLogin();">
                            <div class="form-space">
                                <label class="form-label">Nom d'utilisateur</label>
                                <input type="text" id="username" class="form-input" placeholder="Votre nom d'utilisateur" required>
                            </div>
                            <div class="form-space">
                                <label class="form-label">Mot de passe</label>
                                <input type="password" id="password" class="form-input" placeholder="Votre mot de passe" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Se connecter</button>
                        </form>
                        
                        <div class="test-accounts">
                            <h3>Comptes de test :</h3>
                            <div><strong>Admin:</strong> admin / admin123</div>
                            <div><strong>Commercial:</strong> sarah / sarah123</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHeader() {
            const filteredVentes = getFilteredVentes();
            
            return `
                <div class="header">
                    <div class="container">
                        <div class="header-content">
                            <div>
                                <h1>Suivi des Ventes - Assurance</h1>
                                <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                    Connecté : <strong>${appState.currentUser.name}</strong>
                                    ${appState.currentUser.type === 'commercial' ? ` (${appState.currentUser.agence})` : ''}
                                </p>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                <!-- Sélecteur période -->
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 0.875rem;">📅</span>
                                    <select onchange="appState.selectedMonth = parseInt(this.value); render();" class="form-select" style="padding: 0.25rem 0.5rem;">
                                        ${Array.from({length: 12}, (_, i) => `
                                            <option value="${i+1}" ${appState.selectedMonth === i+1 ? 'selected' : ''}>
                                                ${new Date(0, i).toLocaleDateString('fr-FR', { month: 'long' })}
                                            </option>
                                        `).join('')}
                                    </select>
                                    <select onchange="appState.selectedYear = parseInt(this.value); render();" class="form-select" style="padding: 0.25rem 0.5rem;">
                                        ${[2023, 2024, 2025].map(year => `
                                            <option value="${year}" ${appState.selectedYear === year ? 'selected' : ''}>${year}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div class="nav-buttons">
                                    <button onclick="setView('dashboard')" class="btn ${appState.currentView === 'dashboard' ? 'btn-primary' : 'btn-secondary'}">
                                        📊 Dashboard
                                    </button>
                                    
                                    ${appState.currentUser.type === 'commercial' ? `
                                        <button onclick="setView('saisie')" class="btn ${appState.currentView === 'saisie' ? 'btn-primary' : 'btn-secondary'}">
                                            ➕ Nouvelle vente
                                        </button>
                                        <button onclick="setView('liste')" class="btn ${appState.currentView === 'liste' ? 'btn-primary' : 'btn-secondary'}">
                                            👁️ Mes ventes (${filteredVentes.length})
                                        </button>
                                    ` : ''}
                                    
                                    ${appState.currentUser.type === 'admin' ? `
                                        <button onclick="setView('liste')" class="btn ${appState.currentView === 'liste' ? 'btn-primary' : 'btn-secondary'}">
                                            👁️ Toutes les ventes (${filteredVentes.length})
                                        </button>
                                        <button onclick="setView('gestion')" class="btn ${appState.currentView === 'gestion' ? 'btn-primary' : 'btn-secondary'}">
                                            ⚙️ Gestion
                                        </button>
                                    ` : ''}
                                    
                                    <button onclick="handleLogout()" class="btn btn-danger">
                                        🚪 Déconnexion
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const stats = getStats();
            
            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total ventes</div>
                        <div class="stat-value" style="color: #2563eb;">${stats.totalVentes}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">CA Total</div>
                        <div class="stat-value" style="color: #059669;">${stats.totalCA.toFixed(2)}€</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">PNA Total</div>
                        <div class="stat-value" style="color: #7c3aed;">${stats.totalPNA.toFixed(2)}€</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">CA Moyen</div>
                        <div class="stat-value" style="color: #ea580c;">
                            ${stats.totalVentes > 0 ? (stats.totalCA / stats.totalVentes).toFixed(2) : '0'}€
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">Répartition Tél vs Face à face</h3>
                    <div style="display: grid; gap: 1rem;">
                        ${Object.entries(stats.telVsFaceAFace).map(([type, count]) => {
                            const percentage = stats.totalVentes > 0 ? (count / stats.totalVentes * 100).toFixed(1) : 0;
                            return `
                                <div>
                                    <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.5rem;">
                                        <span>${type}</span>
                                        <span>${count} ventes (${percentage}%)</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${percentage}%; background-color: ${type === 'Tél' ? '#3b82f6' : '#10b981'};"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderSaisie() {
            if (appState.currentUser.type !== 'commercial') {
                return '<div class="card"><p>Accès non autorisé</p></div>';
            }
            
            return `
                <div class="card">
                    <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem;">
                        ${appState.editingId ? 'Modifier la vente' : 'Nouvelle vente'}
                    </h2>
                    
                    <form onsubmit="event.preventDefault(); handleSubmit();">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Nom *</label>
                                <input type="text" class="form-input" value="${appState.formData.nom}" 
                                    onchange="updateFormField('nom', this.value)" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Prénom *</label>
                                <input type="text" class="form-input" value="${appState.formData.prenom}" 
                                    onchange="updateFormField('prenom', this.value)" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Type de vente *</label>
                                <select class="form-select" onchange="updateFormField('vente', this.value)" required>
                                    <option value="">Sélectionner</option>
                                    ${typesVente.map(type => `
                                        <option value="${type}" ${appState.formData.vente === type ? 'selected' : ''}>${type}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Rattachement *</label>
                                <select class="form-select" onchange="updateFormField('rattachement', this.value)" required>
                                    <option value="">Sélectionner</option>
                                    ${getRattachementOptions().map(option => `
                                        <option value="${option}" ${appState.formData.rattachement === option ? 'selected' : ''}>${option}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Origine *</label>
                                <select class="form-select" onchange="updateFormField('origine', this.value)" required>
                                    <option value="">Sélectionner</option>
                                    ${origines.map(origine => `
                                        <option value="${origine}" ${appState.formData.origine === origine ? 'selected' : ''}>${origine}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Contrat *</label>
                                <select class="form-select" onchange="updateFormField('contrat', this.value)" required>
                                    <option value="">Sélectionner</option>
                                    ${appState.contrats.map(contrat => `
                                        <option value="${contrat}" ${appState.formData.contrat === contrat ? 'selected' : ''}>${contrat}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Date effet *</label>
                                <input type="date" class="form-input" value="${appState.formData.dateEffet}" 
                                    onchange="updateFormField('dateEffet', this.value)" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Chiffre d'affaires (€) *</label>
                                <input type="number" step="0.01" class="form-input" value="${appState.formData.chiffreAffaires}" 
                                    onchange="updateFormField('chiffreAffaires', this.value)" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">PNA (€) *</label>
                                <input type="number" step="0.01" class="form-input" value="${appState.formData.pna}" 
                                    onchange="updateFormField('pna', this.value)" required>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                            <button type="submit" class="btn btn-primary">
                                ${appState.editingId ? 'Modifier la vente' : 'Enregistrer la vente'}
                            </button>
                            ${appState.editingId ? `
                                <button type="button" onclick="resetForm(); render();" class="btn btn-secondary">
                                    Annuler
                                </button>
                            ` : ''}
                        </div>
                    </form>
                </div>
            `;
        }

        function renderListe() {
            const filteredVentes = getFilteredVentes();
            
            return `
                <div class="card">
                    <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem; margin-bottom: 1rem;">
                        <h2 style="font-size: 1.25rem; font-weight: 600;">
                            ${appState.currentUser.type === 'commercial' ? 'Mes ventes' : 'Liste des ventes'} 
                            (${filteredVentes.length})
                        </h2>
                        <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                            Période : ${new Date(0, appState.selectedMonth - 1).toLocaleDateString('fr-FR', { month: 'long' })} ${appState.selectedYear}
                        </p>
                    </div>
                    
                    ${filteredVentes.length === 0 ? `
                        <div style="padding: 2rem; text-align: center; color: #6b7280;">
                            <div style="font-size: 1.125rem; margin-bottom: 0.5rem;">Aucune vente pour cette période</div>
                            <div style="font-size: 0.875rem;">Cliquez sur "Nouvelle vente" pour commencer</div>
                        </div>
                    ` : `
                        <div style="overflow-x: auto;">
                            <table class="table">
                                <thead>
                                    <tr>
                                        ${appState.currentUser.type === 'admin' ? '<th>Commercial</th>' : ''}
                                        <th>Client</th>
                                        <th>Contrat</th>
                                        <th>Type</th>
                                        <th>Rattachement</th>
                                        <th>CA (€)</th>
                                        <th>PNA (€)</th>
                                        <th>Date effet</th>
                                        <th style="text-align: right;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredVentes.map(vente => `
                                        <tr>
                                            ${appState.currentUser.type === 'admin' ? `<td style="font-weight: 500;">${vente.commercial}</td>` : ''}
                                            <td>${vente.nom} ${vente.prenom}</td>
                                            <td>${vente.contrat}</td>
                                            <td>
                                                <span class="badge ${vente.vente === 'Tél' ? 'badge-blue' : 'badge-green'}">
                                                    ${vente.vente}
                                                </span>
                                            </td>
                                            <td>${vente.rattachement}</td>
                                            <td style="font-weight: 500; color: #059669;">
                                                ${parseFloat(vente.chiffreAffaires || 0).toFixed(2)}
                                            </td>
                                            <td style="font-weight: 500; color: #7c3aed;">
                                                ${parseFloat(vente.pna || 0).toFixed(2)}
                                            </td>
                                            <td>${vente.dateEffet}</td>
                                            <td style="text-align: right;">
                                                ${(appState.currentUser.type === 'admin' || vente.commercial === appState.currentUser.name) ? `
                                                    <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                                                        <button onclick="handleEdit(${JSON.stringify(vente).replace(/"/g, '&quot;')})" 
                                                            class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                                            title="Modifier">
                                                            ✏️
                                                        </button>
                                                        <button onclick="handleDelete(${vente.id})" 
                                                            class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                                            title="Supprimer">
                                                            🗑️
                                                        </button>
                                                    </div>
                                                ` : ''}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            `;
        }

        function renderGestion() {
            if (appState.currentUser.type !== 'admin') {
                return '<div class="card"><p>Accès non autorisé</p></div>';
            }
            
            return `
                <div class="card">
                    <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem;">Gestion - Fonctionnalités avancées</h2>
                    <div style="color: #6b7280;">
                        <p style="margin-bottom: 1rem;">Section de gestion pour l'administrateur.</p>
                        <p style="margin-bottom: 1rem;">Fonctionnalités disponibles :</p>
                        <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                            <li>Gestion des commerciaux</li>
                            <li>Configuration des contrats</li>
                            <li>Export/Import des données</li>
                            <li>Statistiques avancées</li>
                        </ul>
                        
                        <div style="margin-top: 2rem;">
                            <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #1f2937;">Actions rapides :</h3>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <button onclick="exportData()" class="btn btn-success">
                                    💾 Exporter les données
                                </button>
                                <button onclick="showImportDialog()" class="btn btn-secondary">
                                    📁 Importer des données
                                </button>
                                <button onclick="resetAllData()" class="btn btn-danger">
                                    ⚠️ Réinitialiser
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Fonctions supplémentaires pour la gestion
        function exportData() {
            const dataToExport = {
                ventes: appState.ventes,
                users: appState.users,
                contrats: appState.contrats,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { 
                type: 'application/json' 
            });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = `backup_sales_tracker_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Données exportées avec succès !');
        }

        function showImportDialog() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        if (importedData.ventes) {
                            appState.ventes = importedData.ventes;
                        }
                        if (importedData.users) {
                            appState.users = importedData.users;
                        }
                        if (importedData.contrats) {
                            appState.contrats = importedData.contrats;
                        }
                        
                        saveData();
                        render();
                        alert('Données importées avec succès !');
                    } catch (error) {
                        alert('Erreur lors de l\'import. Vérifiez le format du fichier.');
                        console.error('Erreur import:', error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function resetAllData() {
            if (confirm('⚠️ ATTENTION ! Cette action va supprimer toutes les données (ventes, utilisateurs personnalisés, contrats). Êtes-vous sûr ?')) {
                if (confirm('Dernière confirmation : Toutes les données seront perdues définitivement !')) {
                    appState.ventes = [];
                    appState.users = {...defaultUsers};
                    appState.contrats = [...defaultContrats];
                    localStorage.removeItem('salesTrackerData');
                    render();
                    alert('Toutes les données ont été réinitialisées !');
                }
            }
        }

        // Initialisation de l'application
        function init() {
            loadData();
            render();
        }

        // Gestion des événements clavier pour le login
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !appState.currentUser) {
                const usernameField = document.getElementById('username');
                const passwordField = document.getElementById('password');
                if (usernameField && passwordField && (document.activeElement === usernameField || document.activeElement === passwordField)) {
                    handleLogin();
                }
            }
        });

        // Lancement de l'application
        init();
    </script>
</body>
</html>
