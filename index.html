<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi des Ventes - Assurance (Firebase)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb; color: #111827;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
        .header { background: white; border-bottom: 1px solid #e5e7eb; padding: 1rem 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .header h1 { font-size: 1.5rem; font-weight: 700; color: #1f2937; }
        .nav-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn { 
            padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer;
            font-size: 0.875rem; font-weight: 500; transition: all 0.2s;
            text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        .btn-secondary:hover { background: #e5e7eb; }
        .btn-success { background: #059669; color: white; }
        .btn-success:hover { background: #047857; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .card { 
            background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem; margin-bottom: 1.5rem;
        }
        .stats-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem; margin-bottom: 2rem;
        }
        .stat-card { background: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-label { font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem; }
        .stat-value { font-size: 1.5rem; font-weight: 700; }
        .form-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem; margin-bottom: 1.5rem;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
        .form-input, .form-select { 
            padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem;
            font-size: 0.875rem; transition: border-color 0.2s;
        }
        .form-input:focus, .form-select:focus { 
            outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .table th, .table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .table th { background: #f9fafb; font-weight: 600; font-size: 0.875rem; color: #374151; }
        .table tr:hover { background: #f9fafb; }
        .login-container { 
            min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem;
        }
        .login-card { 
            background: white; padding: 2rem; border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px;
        }
        .login-title { font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 1.5rem; color: #1f2937; }
        .form-space { margin-bottom: 1rem; }
        .test-accounts { margin-top: 2rem; padding: 1rem; background: #f9fafb; border-radius: 0.5rem; }
        .test-accounts h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; color: #1f2937; }
        .test-accounts div { font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem; }
        .progress-bar { 
            width: 100%; height: 0.5rem; background: #e5e7eb; border-radius: 0.25rem;
            margin-top: 0.5rem; overflow: hidden;
        }
        .progress-fill { height: 100%; border-radius: 0.25rem; transition: width 0.3s ease; }
        .badge { 
            display: inline-block; padding: 0.25rem 0.5rem; border-radius: 9999px;
            font-size: 0.75rem; font-weight: 500;
        }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-yellow { background: #fef3c7; color: #92400e; }
        .firebase-status { 
            position: fixed; top: 1rem; right: 1rem; z-index: 1000;
            padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500;
        }
        .firebase-connected { background: #d1fae5; color: #065f46; }
        .firebase-disconnected { background: #fee2e2; color: #991b1b; }
        .firebase-loading { background: #fef3c7; color: #92400e; }
        .config-notice { 
            background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.5rem;
            padding: 1rem; margin-bottom: 1rem; color: #92400e;
        }
        @media (max-width: 768px) {
            .header-content { flex-direction: column; align-items: stretch; }
            .nav-buttons { justify-content: center; }
            .form-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="firebase-status" class="firebase-status firebase-loading">üîÑ Initialisation Firebase...</div>
    <div id="app"></div>

    <!-- Firebase v9 SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            updateDoc, 
            deleteDoc, 
            doc, 
            onSnapshot,
            query,
            orderBy,
            where
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // ‚ö†Ô∏è CONFIGURATION FIREBASE √Ä REMPLACER
        const firebaseConfig = {
            apiKey: "VOTRE_API_KEY",
            authDomain: "VOTRE_PROJECT.firebaseapp.com",
            projectId: "VOTRE_PROJECT_ID",
            storageBucket: "VOTRE_PROJECT.appspot.com",
            messagingSenderId: "123456789",
            appId: "VOTRE_APP_ID"
        };

        // Variables globales
        let app;
        let db;
        let isFirebaseReady = false;
        
        // Donn√©es par d√©faut (identiques √† la version locale)
        const defaultUsers = {
            "admin": { password: "admin123", type: "admin", name: "Administrateur" },
            "sarah": { password: "sarah123", type: "commercial", name: "Sarah", agence: "Lille", permanences: ["Armenti√®res", "Bousbecques", "Lesquin", "Carvin"] },
            "caroline": { password: "caroline123", type: "commercial", name: "Caroline", agence: "Lille", permanences: ["Arras", "B√©thune", "Valenciennes", "La Bass√©e"] },
            "laurence": { password: "laurence123", type: "commercial", name: "Laurence", agence: "Lille", permanences: ["Cambrai", "Feignies", "Flers en Escrebieux"] },
            "sophie": { password: "sophie123", type: "commercial", name: "Sophie", agence: "Compi√®gne", permanences: ["Chauny", "Laon", "Saint Quentin", "Soissons"] },
            "christelle": { password: "christelle123", type: "commercial", name: "Christelle", agence: "Compi√®gne", permanences: ["Beauvais", "Gouvieux", "Mouy", "St Just en chauss√©e"] },
            "aldo": { password: "aldo123", type: "commercial", name: "Aldo", agence: "Boves", permanences: [] },
            "celine": { password: "celine123", type: "commercial", name: "C√©line", agence: "Boves", permanences: ["Doullens", "Saint Valery", "Albert", "P√©ronne", "Poix de Picardie", "Abbeville"] },
            "july": { password: "july123", type: "commercial", name: "July", agence: "Caen", permanences: [] },
            "cedric": { password: "cedric123", type: "commercial", name: "C√©dric", agence: "Caen", permanences: ["Cherbourg", "Granville", "Saint L√¥", "Alen√ßon", "Argentan", "Flers"] },
            "messa": { password: "messa123", type: "commercial", name: "Messa", agence: "Rouen", permanences: ["√âvreux", "Vernon", "Louviers"] },
            "amandine": { password: "amandine123", type: "commercial", name: "Amandine", agence: "Calais", permanences: ["Saint Omer", "Saint Leonard", "Hesdin", "Hazebrouck", "√âtaples"] },
            "annabelle": { password: "annabelle123", type: "commercial", name: "Annabelle", agence: "Le Havre", permanences: ["Lisieux", "Yvetot", "Pont Audemer"] }
        };

        const defaultContrats = [
            "Sant√© sortie de groupe", "Pr√©voyance individuelle", "Protectvia", "Viv√©pargne",
            "Prima Cap obsq Pu", "Prima Cap obsq PP", "Prima Vol obsq Pu", "Prima vol obsq Pu",
            "Certificats Mutualistes", "Viaplus", "Protec territorial", "HPJ", "Terre de vie",
            "Gpa", "Multiprima", "Mutame", "Perte autonomie", "Patrimoine s√©lection"
        ];

        const typesVente = ["Face √† face", "T√©l"];
        const origines = ["Prcad", "Rebond Crc", "Client", "Campagne", "Reco", "Visite", "Sant√© sortie de groupe"];

        // √âtat de l'application
        const appState = {
            users: JSON.parse(JSON.stringify(defaultUsers)),
            contrats: defaultContrats.slice(),
            typesVente: typesVente.slice(),
            origines: origines.slice(),
            rattachements: [],
            currentUser: null,
            currentView: 'dashboard',
            selectedMonth: new Date().getMonth() + 1,
            selectedYear: new Date().getFullYear(),
            ventes: [],
            editingId: null,
            showContractForm: false,
            showTypeVenteForm: false,
            showOrigineForm: false,
            showRattachementForm: false,
            showUserForm: false,
            editingUser: null,
            newContract: '',
            newTypeVente: '',
            newOrigine: '',
            newRattachement: '',
            newUserForm: { username: '', name: '', password: '', agence: '', permanences: '' },
            editUserForm: { permanences: '' },
            formData: {
                commercial: '', nom: '', prenom: '', age: '', numeroPersonne: '',
                vente: '', rattachement: '', origine: '', contrat: '',
                dateEffet: '', chiffreAffaires: '', pna: '', jourRdv: ''
            }
        };

        // Fonctions Firebase
        function updateFirebaseStatus(status, message) {
            const statusDiv = document.getElementById('firebase-status');
            statusDiv.className = `firebase-status firebase-${status}`;
            statusDiv.innerHTML = message;
        }

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                isFirebaseReady = true;
                updateFirebaseStatus('connected', '‚úÖ Firebase connect√©');
                
                // Charger les donn√©es initiales
                await loadFirebaseData();
                setupRealtimeListeners();
                
                // Masquer le statut apr√®s 3 secondes
                setTimeout(() => {
                    document.getElementById('firebase-status').style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('Erreur Firebase:', error);
                updateFirebaseStatus('disconnected', '‚ùå Erreur Firebase - Mode local');
                // Basculer en mode local
                loadLocalData();
            }
        }

        async function loadFirebaseData() {
            try {
                // Charger les ventes
                const ventesSnapshot = await getDocs(collection(db, 'ventes'));
                appState.ventes = ventesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Charger la configuration
                const configSnapshot = await getDocs(collection(db, 'config'));
                configSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (doc.id === 'contrats') appState.contrats = data.items || defaultContrats;
                    if (doc.id === 'typesVente') appState.typesVente = data.items || typesVente;
                    if (doc.id === 'origines') appState.origines = data.items || origines;
                    if (doc.id === 'rattachements') appState.rattachements = data.items || [];
                    if (doc.id === 'users') appState.users = data.items || defaultUsers;
                });

                render();
            } catch (error) {
                console.error('Erreur chargement Firebase:', error);
            }
        }

        function setupRealtimeListeners() {
            // √âcouter les ventes en temps r√©el
            const ventesQuery = query(collection(db, 'ventes'), orderBy('dateCreation', 'desc'));
            onSnapshot(ventesQuery, (snapshot) => {
                appState.ventes = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                render();
            });
        }

        async function saveVenteToFirebase(vente) {
            if (!isFirebaseReady) return;
            
            try {
                if (vente.id && typeof vente.id === 'string') {
                    // Mise √† jour
                    const { id, ...venteData } = vente;
                    await updateDoc(doc(db, 'ventes', id), venteData);
                } else {
                    // Nouvelle vente
                    const { id, ...venteData } = vente;
                    await addDoc(collection(db, 'ventes'), venteData);
                }
            } catch (error) {
                console.error('Erreur sauvegarde vente:', error);
                alert('Erreur de sauvegarde. V√©rifiez votre connexion.');
            }
        }

        async function deleteVenteFromFirebase(venteId) {
            if (!isFirebaseReady) return;
            
            try {
                await deleteDoc(doc(db, 'ventes', venteId));
            } catch (error) {
                console.error('Erreur suppression vente:', error);
                alert('Erreur de suppression. V√©rifiez votre connexion.');
            }
        }

        async function saveConfigToFirebase(configType, items) {
            if (!isFirebaseReady) return;
            
            try {
                await updateDoc(doc(db, 'config', configType), { items });
            } catch (error) {
                // Si le document n'existe pas, le cr√©er
                try {
                    await addDoc(collection(db, 'config'), { items });
                } catch (createError) {
                    console.error('Erreur sauvegarde config:', createError);
                }
            }
        }

        // Fonctions utilitaires (reprises de la version locale)
        function loadLocalData() {
            try {
                const savedData = localStorage.getItem('salesTrackerData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.ventes) appState.ventes = data.ventes;
                    if (data.users) appState.users = data.users;
                    if (data.contrats) appState.contrats = data.contrats;
                    if (data.typesVente) appState.typesVente = data.typesVente;
                    if (data.origines) appState.origines = data.origines;
                    if (data.rattachements) appState.rattachements = data.rattachements;
                }
            } catch (error) {
                console.error('Erreur chargement local:', error);
            }
        }

        function saveLocalData() {
            try {
                const data = {
                    ventes: appState.ventes,
                    users: appState.users,
                    contrats: appState.contrats,
                    typesVente: appState.typesVente,
                    origines: appState.origines,
                    rattachements: appState.rattachements
                };
                localStorage.setItem('salesTrackerData', JSON.stringify(data));
            } catch (error) {
                console.error('Erreur sauvegarde locale:', error);
            }
        }

        function getRattachementOptions() {
            let options = [];
            
            if (appState.currentUser && appState.currentUser.type === 'commercial') {
                options.push(appState.currentUser.agence);
                options = options.concat(appState.currentUser.permanences);
            } else if (appState.formData.commercial) {
                const users = Object.values(appState.users);
                const user = users.find(u => u.name === appState.formData.commercial);
                if (user && user.type === 'commercial') {
                    options.push(user.agence);
                    options = options.concat(user.permanences);
                }
            }
            
            options = options.concat(appState.rattachements);
            return [...new Set(options)]; // Supprimer les doublons
        }

        function getFilteredVentes() {
            let filtered = appState.ventes.slice();
            
            if (appState.currentUser && appState.currentUser.type === 'commercial') {
                filtered = filtered.filter(v => v.commercial === appState.currentUser.name);
            }
            
            filtered = filtered.filter(v => {
                if (!v.dateEffet) return false;
                const date = new Date(v.dateEffet);
                return date.getMonth() + 1 === appState.selectedMonth && date.getFullYear() === appState.selectedYear;
            });
            
            return filtered;
        }

        function getStats() {
            const ventesFiltered = getFilteredVentes();
            const totalVentes = ventesFiltered.length;
            let totalCA = 0;
            let totalPNA = 0;
            
            ventesFiltered.forEach(v => {
                totalCA += parseFloat(v.chiffreAffaires) || 0;
                totalPNA += parseFloat(v.pna) || 0;
            });
            
            const telVsFaceAFace = { "T√©l": 0, "Face √† face": 0 };
            const ventesParCommercial = {};
            const ventesParOrigine = {};
            const ventesParLieu = {};
            const ventesParProduit = {};
            
            ventesFiltered.forEach(v => {
                if (v.vente) telVsFaceAFace[v.vente]++;
                
                if (!ventesParCommercial[v.commercial]) {
                    ventesParCommercial[v.commercial] = { ventes: 0, ca: 0, pna: 0 };
                }
                ventesParCommercial[v.commercial].ventes++;
                ventesParCommercial[v.commercial].ca += parseFloat(v.chiffreAffaires) || 0;
                ventesParCommercial[v.commercial].pna += parseFloat(v.pna) || 0;
                
                if (v.origine && v.origine.trim()) {
                    ventesParOrigine[v.origine] = (ventesParOrigine[v.origine] || 0) + 1;
                }
                
                if (v.rattachement && v.rattachement.trim()) {
                    ventesParLieu[v.rattachement] = (ventesParLieu[v.rattachement] || 0) + 1;
                }
                
                if (v.contrat && v.contrat.trim()) {
                    ventesParProduit[v.contrat] = (ventesParProduit[v.contrat] || 0) + 1;
                }
            });
            
            return { 
                totalVentes, totalCA, totalPNA, telVsFaceAFace, 
                ventesParCommercial, ventesParOrigine, ventesParLieu, ventesParProduit 
            };
        }

        // Fonctions d'action
        function handleLogin() {
            const username = document.getElementById('username').value.toLowerCase();
            const password = document.getElementById('password').value;
            
            const user = appState.users[username];
            if (user && user.password === password) {
                appState.currentUser = { ...user, username };
                render();
            } else {
                alert('Nom d\'utilisateur ou mot de passe incorrect');
            }
        }

        function handleLogout() {
            appState.currentUser = null;
            appState.currentView = 'dashboard';
            resetForm();
            render();
        }

        function resetForm() {
            appState.formData = {
                commercial: '', nom: '', prenom: '', age: '', numeroPersonne: '',
                vente: '', rattachement: '', origine: '', contrat: '',
                dateEffet: '', chiffreAffaires: '', pna: '', jourRdv: ''
            };
            appState.editingId = null;
        }

        async function handleSubmit() {
            const commercial = appState.currentUser.type === 'commercial' ? appState.currentUser.name : appState.formData.commercial;
            
            if (!commercial || !appState.formData.nom || !appState.formData.prenom || !appState.formData.vente || 
                !appState.formData.rattachement || !appState.formData.origine || !appState.formData.contrat || 
                !appState.formData.dateEffet || !appState.formData.chiffreAffaires || !appState.formData.pna) {
                alert('Veuillez remplir tous les champs obligatoires (*)');
                return;
            }
            
            const venteFinal = { ...appState.formData, commercial };
            
            if (appState.editingId) {
                venteFinal.id = appState.editingId;
                const existingVente = appState.ventes.find(v => v.id === appState.editingId);
                venteFinal.dateCreation = existingVente?.dateCreation || new Date().toISOString();
            } else {
                venteFinal.id = Date.now().toString();
                venteFinal.dateCreation = new Date().toISOString();
            }
            
            // Sauvegarder dans Firebase
            await saveVenteToFirebase(venteFinal);
            
            // Fallback local
            if (!isFirebaseReady) {
                if (appState.editingId) {
                    const index = appState.ventes.findIndex(v => v.id === appState.editingId);
                    if (index !== -1) appState.ventes[index] = venteFinal;
                } else {
                    appState.ventes.push(venteFinal);
                }
                saveLocalData();
            }
            
            resetForm();
            alert(appState.editingId ? 'Vente modifi√©e !' : 'Vente ajout√©e !');
            render();
        }

        function handleEdit(vente) {
            appState.formData = { ...vente };
            appState.editingId = vente.id;
            appState.currentView = 'saisie';
            render();
        }

        async function handleDelete(id) {
            if (confirm('Supprimer cette vente ?')) {
                await deleteVenteFromFirebase(id);
                
                if (!isFirebaseReady) {
                    appState.ventes = appState.ventes.filter(v => v.id !== id);
                    saveLocalData();
                }
                
                alert('Vente supprim√©e !');
                render();
            }
        }

        function setView(view) {
            appState.currentView = view;
            if (view !== 'saisie') resetForm();
            render();
        }

        function updateFormField(field, value) {
            appState.formData[field] = value;
            if (field === 'commercial') appState.formData.rattachement = '';
        }

        // Fonctions de rendu (identiques √† la version locale avec ajouts Firebase)
        function render() {
            const app = document.getElementById('app');
            
            if (!appState.currentUser) {
                renderLogin();
                return;
            }
            
            app.innerHTML = '';
            renderHeader();
            
            const container = document.createElement('div');
            container.className = 'container';
            container.style.paddingTop = '1.5rem';
            
            if (appState.currentView === 'dashboard') renderDashboard(container);
            else if (appState.currentView === 'saisie') renderSaisie(container);
            else if (appState.currentView === 'liste') renderListe(container);
            else if (appState.currentView === 'gestion') renderGestion(container);
            
            app.appendChild(container);
        }

        function renderLogin() {
            const app = document.getElementById('app');
            
            // V√©rifier si Firebase est configur√©
            const isConfigured = firebaseConfig.apiKey !== "VOTRE_API_KEY";
            
            let configNotice = '';
            if (!isConfigured) {
                configNotice = `
                    <div class="config-notice">
                        <h3 style="margin-bottom: 0.5rem;">‚ö†Ô∏è Configuration Firebase requise</h3>
                        <p style="margin-bottom: 0.5rem;">Pour utiliser la synchronisation cloud, vous devez :</p>
                        <ol style="margin-left: 1rem;">
                            <li>Cr√©er un projet Firebase sur <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a></li>
                            <li>Activer Firestore Database</li>
                            <li>Remplacer la configuration Firebase dans le code</li>
                        </ol>
                        <p style="margin-top: 0.5rem;"><strong>En attendant, l'application fonctionne en mode local.</strong></p>
                    </div>
                `;
            }
            
            const html = `
                <div class="login-container">
                    <div class="login-card">
                        ${configNotice}
                        <h1 class="login-title">Suivi des Ventes - Firebase</h1>
                        <form onsubmit="event.preventDefault(); handleLogin();">
                            <div class="form-space">
                                <label class="form-label">Nom d'utilisateur</label>
                                <input type="text" id="username" class="form-input" placeholder="Votre nom d'utilisateur" required>
                            </div>
                            <div class="form-space">
                                <label class="form-label">Mot de passe</label>
                                <input type="password" id="password" class="form-input" placeholder="Votre mot de passe" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Se connecter</button>
                        </form>
                        <div class="test-accounts">
                            <h3>Comptes de test :</h3>
                            <div><strong>Admin:</strong> admin / admin123</div>
                            <div><strong>Commercial:</strong> sarah / sarah
