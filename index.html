<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi des Ventes - Assurance (React)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb; color: #111827;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
        .header { background: white; border-bottom: 1px solid #e5e7eb; padding: 1rem 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .header h1 { font-size: 1.5rem; font-weight: 700; color: #1f2937; }
        .nav-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn { 
            padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer;
            font-size: 0.875rem; font-weight: 500; transition: all 0.2s;
            text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        .btn-secondary:hover { background: #e5e7eb; }
        .btn-success { background: #059669; color: white; }
        .btn-success:hover { background: #047857; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .card { 
            background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem; margin-bottom: 1.5rem;
        }
        .stats-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem; margin-bottom: 2rem;
        }
        .stat-card { background: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-label { font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem; }
        .stat-value { font-size: 1.5rem; font-weight: 700; }
        .form-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem; margin-bottom: 1.5rem;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
        .form-input, .form-select { 
            padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem;
            font-size: 0.875rem; transition: border-color 0.2s;
        }
        .form-input:focus, .form-select:focus { 
            outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .table th, .table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .table th { background: #f9fafb; font-weight: 600; font-size: 0.875rem; color: #374151; }
        .table tr:hover { background: #f9fafb; }
        .login-container { 
            min-height: 100vh; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            display: flex; align-items: center; justify-content: center; padding: 1rem;
        }
        .login-card { 
            background: white; padding: 3rem; border-radius: 1.5rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 440px;
            animation: slideUp 0.5s ease-out;
        }
        .progress-bar { 
            width: 100%; height: 0.5rem; background: #e5e7eb; border-radius: 0.25rem;
            margin-top: 0.5rem; overflow: hidden;
        }
        .progress-fill { height: 100%; border-radius: 0.25rem; transition: width 0.3s ease; }
        .badge { 
            display: inline-block; padding: 0.25rem 0.5rem; border-radius: 9999px;
            font-size: 0.75rem; font-weight: 500;
        }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-yellow { background: #fef3c7; color: #92400e; }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .notification {
            position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem;
            border-radius: 0.75rem; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 10000; animation: slideIn 0.3s ease-out;
            max-width: 400px; display: flex; align-items: center; gap: 0.75rem;
        }
        .notification-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .notification-error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .notification-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: flex;
            align-items: center; justify-content: center; z-index: 9999;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white; border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6); display: flex;
            align-items: center; justify-content: center; z-index: 10001;
            animation: fadeIn 0.2s ease-out;
        }
        .modal {
            background: white; padding: 2rem; border-radius: 1rem;
            max-width: 450px; width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: scaleIn 0.2s ease-out;
        }
        .modal-header {
            display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
        }
        .modal-icon {
            width: 48px; height: 48px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; flex-shrink: 0;
        }
        .modal-icon-danger { background: #fee2e2; color: #dc2626; }
        .modal-icon-info { background: #dbeafe; color: #1e40af; }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: #1f2937; }
        .modal-body { color: #6b7280; line-height: 1.5; margin-bottom: 1.5rem; }
        .modal-footer { display: flex; gap: 0.75rem; justify-content: flex-end; }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @media (max-width: 768px) {
            .header-content { flex-direction: column; align-items: stretch; }
            .nav-buttons { justify-content: center; }
            .form-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyCskhBW5hoqNYl8dA9mW0tnZRh4FrznGAE",
            authDomain: "suivi-ventes-ag2r-37eeb.firebaseapp.com",
            projectId: "suivi-ventes-ag2r-37eeb",
            storageBucket: "suivi-ventes-ag2r-37eeb.firebasestorage.app",
            messagingSenderId: "532494330267",
            appId: "1:532494330267:web:89bb6d3e6611e6efa3593e",
            measurementId: "G-1MYECDKJEF"
        };

        // Initialisation Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ========== COMPOSANTS UTILITAIRES ==========
        
        function Notification({ message, type, onClose }) {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ';

            return (
                <div className={`notification notification-${type}`}>
                    <span style={{ fontSize: '1.5rem' }}>{icon}</span>
                    <span style={{ flex: 1 }}>{message}</span>
                </div>
            );
        }

        function LoadingOverlay() {
            return (
                <div className="loading-overlay">
                    <div className="spinner"></div>
                </div>
            );
        }

        function ConfirmModal({ title, message, onConfirm, onCancel }) {
            return (
                <div className="modal-overlay" onClick={onCancel}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <div className="modal-icon modal-icon-danger">‚ö†Ô∏è</div>
                            <div className="modal-title">{title}</div>
                        </div>
                        <div className="modal-body">{message}</div>
                        <div className="modal-footer">
                            <button className="btn btn-secondary" onClick={onCancel}>
                                Annuler
                            </button>
                            <button className="btn btn-danger" onClick={onConfirm}>
                                Confirmer
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
function CommentModal({ vente, onClose }) {
    return (
        <div className="modal-overlay" onClick={onClose}>
            <div className="modal" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <div className="modal-icon modal-icon-info">üí¨</div>
                    <div className="modal-title">Commentaire</div>
                </div>
                <div className="modal-body" style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-word' }}>
                    <strong>{vente.nom} {vente.prenom}</strong>
                    {'\n\n'}
                    {vente.commentaire || 'Aucun commentaire'}
                </div>
                <div className="modal-footer">
                    <button className="btn btn-primary" onClick={onClose}>
                        Fermer
                    </button>
                </div>
            </div>
        </div>
    );
}
        // ========== PAGE DE CONNEXION ==========
        
        function LoginPage({ onLogin }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    // onAuthStateChanged g√©rera la connexion
                } catch (error) {
                    alert('Email ou mot de passe incorrect');
                }

                setLoading(false);
            };

            return (
                <div className="login-container">
                    <div className="login-card">
                        <div style={{ textAlign: 'center', marginBottom: '2.5rem' }}>
                            <div style={{ 
                                width: '80px', height: '80px', 
                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                borderRadius: '50%', margin: '0 auto 1.5rem',
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                fontSize: '2.5rem'
                            }}>
                                üìä
                            </div>
                            <h1 style={{ fontSize: '1.75rem', fontWeight: '700', color: '#1f2937', marginBottom: '0.5rem' }}>
                                Suivi des Ventes
                            </h1>
                            <p style={{ color: '#6b7280', fontSize: '0.95rem' }}>
                                Connectez-vous √† votre espace
                            </p>
                        </div>

                        <form onSubmit={handleSubmit}>
                            <div style={{ marginBottom: '1.5rem' }}>
                                <label style={{ display: 'block', fontSize: '0.875rem', fontWeight: '600', color: '#374151', marginBottom: '0.5rem' }}>
                                    üìß Email
                                </label>
                                <input
                                    type="email"
                                    className="form-input"
                                    style={{ width: '100%' }}
                                    placeholder="votre.email@company.com"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                />
                            </div>

                            <div style={{ marginBottom: '2rem' }}>
                                <label style={{ display: 'block', fontSize: '0.875rem', fontWeight: '600', color: '#374151', marginBottom: '0.5rem' }}>
                                    üîí Mot de passe
                                </label>
                                <input
                                    type="password"
                                    className="form-input"
                                    style={{ width: '100%' }}
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                />
                            </div>

                            <button
                                type="submit"
                                className="btn btn-primary"
                                style={{ width: '100%', padding: '1rem', fontSize: '1rem' }}
                                disabled={loading}
                            >
                                {loading ? 'üîÑ Connexion...' : 'üöÄ Se connecter'}
                            </button>
                        </form>

                        <div style={{ 
                            marginTop: '2rem', padding: '1.25rem',
                            background: 'linear-gradient(135deg, #f0f4ff 0%, #f5f3ff 100%)',
                            borderRadius: '1rem', border: '1px solid #e0e7ff'
                        }}>
                            <div style={{ fontSize: '0.875rem', fontWeight: '600', color: '#4c51bf', marginBottom: '0.75rem' }}>
                                üí° Acc√®s commercial
                            </div>
                            <div style={{ fontSize: '0.8rem', color: '#6b7280', lineHeight: '1.5' }}>
                                Utilisez vos identifiants professionnels
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ========== HEADER ==========
        
        function Header({ currentUser, currentView, setCurrentView, filters, setFilters, onLogout, onExport, ventesCount }) {
            const commerciaux = Object.keys(currentUser.allUsers || {})
                .filter(email => currentUser.allUsers[email].type === 'commercial')
                .map(email => currentUser.allUsers[email]);

            return (
                <div className="header">
                    <div className="container">
                        <div className="header-content">
                            <div>
                                <h1>Suivi des Ventes - Assurance</h1>
                                <p style={{ fontSize: '0.875rem', color: '#6b7280', marginTop: '0.25rem' }}>
                                    Connect√© : <strong>{currentUser.name}</strong>
                                    {currentUser.type === 'commercial' && ` (${currentUser.agence})`}
                                    <span style={{ color: '#059669', marginLeft: '1rem' }}>‚úì Sauvegarde automatique</span>
                                </p>
                            </div>

                            <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', flexWrap: 'wrap' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                    <span>üìÖ</span>
                                    
                                    <select 
                                        className="form-select" 
                                        style={{ padding: '0.25rem 0.5rem' }}
                                        value={filters.viewMode}
                                        onChange={(e) => setFilters({ ...filters, viewMode: e.target.value })}
                                    >
                                        <option value="mensuel">Vue mensuelle</option>
                                        <option value="annuel">Vue annuelle</option>
                                    </select>

                                    {filters.viewMode === 'mensuel' && (
                                        <select 
                                            className="form-select" 
                                            style={{ padding: '0.25rem 0.5rem' }}
                                            value={filters.month}
                                            onChange={(e) => setFilters({ ...filters, month: parseInt(e.target.value) })}
                                        >
                                            {Array.from({ length: 12 }, (_, i) => {
                                                const name = new Date(0, i).toLocaleDateString('fr-FR', { month: 'long' });
                                                return <option key={i} value={i + 1}>{name}</option>;
                                            })}
                                        </select>
                                    )}

                                    <select 
                                        className="form-select" 
                                        style={{ padding: '0.25rem 0.5rem' }}
                                        value={filters.year}
                                        onChange={(e) => setFilters({ ...filters, year: parseInt(e.target.value) })}
                                    >
                                        <option value="2023">2023</option>
                                        <option value="2024">2024</option>
                                        <option value="2025">2025</option>
                                    </select>

                                    {currentUser.type === 'admin' && (
                                        <>
                                            <span style={{ marginLeft: '0.5rem' }}>üë§</span>
                                            <select 
                                                className="form-select" 
                                                style={{ padding: '0.25rem 0.5rem' }}
                                                value={filters.commercial}
                                                onChange={(e) => setFilters({ ...filters, commercial: e.target.value })}
                                            >
                                                <option value="tous">Tous les commerciaux</option>
                                                {commerciaux.map(c => (
                                                    <option key={c.email} value={c.name}>{c.name}</option>
                                                ))}
                                            </select>
                                        </>
                                    )}
                                </div>

                                <div className="nav-buttons">
                                    <button 
                                        className={`btn ${currentView === 'dashboard' ? 'btn-primary' : 'btn-secondary'}`}
                                        onClick={() => setCurrentView('dashboard')}
                                    >
                                        üìä Dashboard
                                    </button>

                                    {currentUser.type === 'commercial' && (
                                        <>
                                            <button 
                                                className={`btn ${currentView === 'saisie' ? 'btn-primary' : 'btn-secondary'}`}
                                                onClick={() => setCurrentView('saisie')}
                                            >
                                                ‚ûï Nouvelle vente
                                            </button>
                                            <button 
                                                className={`btn ${currentView === 'liste' ? 'btn-primary' : 'btn-secondary'}`}
                                                onClick={() => setCurrentView('liste')}
                                            >
                                                üëÅÔ∏è Mes ventes ({ventesCount})
                                            </button>
                                        </>
                                    )}

                                    {currentUser.type === 'admin' && (
                                        <>
                                            <button 
                                                className={`btn ${currentView === 'liste' ? 'btn-primary' : 'btn-secondary'}`}
                                                onClick={() => setCurrentView('liste')}
                                            >
                                                üëÅÔ∏è Toutes les ventes ({ventesCount})
                                            </button>
                                            <button 
                                                className={`btn ${currentView === 'gestion' ? 'btn-primary' : 'btn-secondary'}`}
                                                onClick={() => setCurrentView('gestion')}
                                            >
                                                ‚öôÔ∏è Gestion
                                            </button>
                                        </>
                                    )}

                                    <button className="btn btn-success" onClick={onExport}>
                                        üíæ Export CSV
                                    </button>

                                    <button className="btn btn-danger" onClick={onLogout}>
                                        üö™ D√©connexion
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ========== DASHBOARD ==========
        
        function Dashboard({ ventes, currentUser }) {
            const stats = useMemo(() => {
                const totalVentes = ventes.length;
                const totalCA = ventes.reduce((sum, v) => sum + (parseFloat(v.chiffreAffaires) || 0), 0);
                const totalPNA = ventes.reduce((sum, v) => sum + (parseFloat(v.pna) || 0), 0);

                const telVsFaceAFace = { "T√©l": 0, "Face √† face": 0 };
                const ventesParOrigine = {};
                const ventesParLieu = {};
                const ventesParProduit = {};
                const ventesParCommercial = {};

                ventes.forEach(v => {
                    if (v.vente) telVsFaceAFace[v.vente]++;
                    if (v.origine) ventesParOrigine[v.origine] = (ventesParOrigine[v.origine] || 0) + 1;
                    if (v.rattachement) ventesParLieu[v.rattachement] = (ventesParLieu[v.rattachement] || 0) + 1;
                    if (v.contrat) ventesParProduit[v.contrat] = (ventesParProduit[v.contrat] || 0) + 1;
                    
                    if (!ventesParCommercial[v.commercial]) {
                        ventesParCommercial[v.commercial] = { ventes: 0, ca: 0, pna: 0 };
                    }
                    ventesParCommercial[v.commercial].ventes++;
                    ventesParCommercial[v.commercial].ca += parseFloat(v.chiffreAffaires) || 0;
                    ventesParCommercial[v.commercial].pna += parseFloat(v.pna) || 0;
                });

                return {
                    totalVentes,
                    totalCA,
                    totalPNA,
                    telVsFaceAFace,
                    ventesParOrigine,
                    ventesParLieu,
                    ventesParProduit,
                    ventesParCommercial
                };
            }, [ventes]);

            const statsData = [
                { label: 'Total ventes', value: stats.totalVentes, color: '#2563eb' },
                { label: 'CA Total', value: `${stats.totalCA.toFixed(2)}‚Ç¨`, color: '#059669' },
                { label: 'PNA Total', value: `${stats.totalPNA.toFixed(2)}‚Ç¨`, color: '#7c3aed' },
                { label: 'CA Moyen', value: `${stats.totalVentes > 0 ? (stats.totalCA / stats.totalVentes).toFixed(2) : '0'}‚Ç¨`, color: '#ea580c' }
            ];

            return (
                <div className="container" style={{ paddingTop: '1.5rem' }}>
                    {/* Stats principales */}
                    <div className="stats-grid">
                        {statsData.map((stat, i) => (
                            <div key={i} className="stat-card">
                                <div className="stat-label">{stat.label}</div>
                                <div className="stat-value" style={{ color: stat.color }}>
                                    {stat.value}
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* T√©l vs Face √† face */}
                    <div className="card">
                        <h3 style={{ fontSize: '1.125rem', fontWeight: '600', marginBottom: '1rem' }}>
                            R√©partition T√©l vs Face √† face
                        </h3>
                        <div style={{ display: 'grid', gap: '1rem' }}>
                            {Object.entries(stats.telVsFaceAFace).map(([type, count]) => {
                                const percentage = stats.totalVentes > 0 ? ((count / stats.totalVentes) * 100).toFixed(1) : 0;
                                const color = type === 'T√©l' ? '#3b82f6' : '#10b981';

                                return (
                                    <div key={type}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.875rem', marginBottom: '0.5rem' }}>
                                            <span>{type}</span>
                                            <span>{count} ventes ({percentage}%)</span>
                                        </div>
                                        <div className="progress-bar">
                                            <div className="progress-fill" style={{ width: `${percentage}%`, backgroundColor: color }}></div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
{/* Performance par Permanence/Agence */}
                    <div className="card">
                        <h3 style={{ fontSize: '1.125rem', fontWeight: '600', marginBottom: '1rem' }}>
                            Performance par Permanence/Agence
                        </h3>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(220px, 1fr))', gap: '1rem' }}>
                            {(() => {
                                const permanencesStats = {};
                                const agencesStats = {};
                                
                                ventes.forEach(vente => {
                                    if (vente.rattachement && vente.rattachement.trim()) {
                                        const isAgence = Object.keys(currentUser.allUsers || {}).some(email => 
                                            currentUser.allUsers[email].type === 'commercial' && 
                                            currentUser.allUsers[email].agence === vente.rattachement
                                        );
                                        
                                        const pnaAmount = parseFloat(vente.pna) || 0;
                                        
                                        if (isAgence) {
                                            if (!agencesStats[vente.rattachement]) {
                                                agencesStats[vente.rattachement] = { ventes: 0, pna: 0 };
                                            }
                                            agencesStats[vente.rattachement].ventes++;
                                            agencesStats[vente.rattachement].pna += pnaAmount;
                                        } else {
                                            if (!permanencesStats[vente.rattachement]) {
                                                permanencesStats[vente.rattachement] = { ventes: 0, pna: 0 };
                                            }
                                            permanencesStats[vente.rattachement].ventes++;
                                            permanencesStats[vente.rattachement].pna += pnaAmount;
                                        }
                                    }
                                });
                                
                                const agencesList = Object.keys(agencesStats).sort();
                                const permanencesList = Object.keys(permanencesStats).sort();
                                
                                return (
                                    <>
                                        {agencesList.map(agence => {
                                            const data = agencesStats[agence];
                                            return (
                                                <div key={agence} style={{ 
                                                    padding: '1rem', 
                                                    background: '#e0f2fe', 
                                                    borderRadius: '0.5rem',
                                                    borderLeft: '4px solid #0277bd'
                                                }}>
                                                    <div style={{ fontSize: '0.875rem', fontWeight: '500', marginBottom: '0.5rem' }}>
                                                        {agence}
                                                        <span className="badge badge-blue" style={{ marginLeft: '0.5rem' }}>Agence</span>
                                                    </div>
                                                    <div style={{ fontSize: '1.125rem', fontWeight: '700', color: '#1f2937' }}>
                                                        {data.ventes} ventes
                                                    </div>
                                                    <div style={{ fontSize: '0.875rem', color: '#0277bd', fontWeight: '500' }}>
                                                        PNA: {data.pna.toFixed(2)}‚Ç¨
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {permanencesList.map(permanence => {
                                            const data = permanencesStats[permanence];
                                            return (
                                                <div key={permanence} style={{ 
                                                    padding: '1rem', 
                                                    background: '#f9fafb', 
                                                    borderRadius: '0.5rem'
                                                }}>
                                                    <div style={{ fontSize: '0.875rem', fontWeight: '500', marginBottom: '0.5rem' }}>
                                                        {permanence}
                                                        <span className="badge badge-yellow" style={{ marginLeft: '0.5rem' }}>Permanence</span>
                                                    </div>
                                                    <div style={{ fontSize: '1.125rem', fontWeight: '700', color: '#1f2937' }}>
                                                        {data.ventes} ventes
                                                    </div>
                                                    <div style={{ fontSize: '0.875rem', color: '#7c3aed', fontWeight: '500' }}>
                                                        PNA: {data.pna.toFixed(2)}‚Ç¨
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {agencesList.length === 0 && permanencesList.length === 0 && (
                                            <div style={{ gridColumn: '1 / -1', textAlign: 'center', color: '#6b7280', padding: '2rem' }}>
                                                Aucune vente pour cette p√©riode
                                            </div>
                                        )}
                                    </>
                                );
                            })()}
                        </div>
                    </div>
                    {/* Performance par Commercial (Admin only) */}
                    {currentUser.type === 'admin' && (
                        <div className="card">
                            <h3 style={{ fontSize: '1.125rem', fontWeight: '600', marginBottom: '1rem' }}>
                                Performance par Commercial
                            </h3>
                            <div style={{ overflowX: 'auto' }}>
                                <table className="table">
                                    <thead>
                                        <tr>
                                            <th>Commercial</th>
                                            <th style={{ textAlign: 'right' }}>Ventes</th>
                                            <th style={{ textAlign: 'right' }}>CA Total</th>
                                            <th style={{ textAlign: 'right' }}>PNA Total</th>
                                            <th style={{ textAlign: 'right' }}>CA Moyen</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {Object.entries(stats.ventesParCommercial)
                                            .sort((a, b) => b[1].ventes - a[1].ventes)
                                            .map(([commercial, data]) => (
                                                <tr key={commercial}>
                                                    <td style={{ fontWeight: '500' }}>{commercial}</td>
                                                    <td style={{ textAlign: 'right' }}>{data.ventes}</td>
                                                    <td style={{ textAlign: 'right', color: '#059669', fontWeight: '500' }}>
                                                        {data.ca.toFixed(2)}‚Ç¨
                                                    </td>
                                                    <td style={{ textAlign: 'right', color: '#7c3aed', fontWeight: '500' }}>
                                                        {data.pna.toFixed(2)}‚Ç¨
                                                    </td>
                                                    <td style={{ textAlign: 'right' }}>
                                                        {data.ventes > 0 ? (data.ca / data.ventes).toFixed(2) : '0'}‚Ç¨
                                                    </td>
                                                </tr>
                                            ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* Performance par Produit */}
                    <div className="card">
                        <h3 style={{ fontSize: '1.125rem', fontWeight: '600', marginBottom: '1rem' }}>
                            Performance par Produit
                        </h3>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem' }}>
                            {Object.entries(stats.ventesParProduit)
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 9)
                                .map(([produit, count]) => (
                                    <div key={produit} style={{ padding: '1rem', background: '#f9fafb', borderRadius: '0.5rem' }}>
                                        <div style={{ fontSize: '0.875rem', fontWeight: '500', marginBottom: '0.5rem', color: '#1f2937' }}>
                                            {produit}
                                        </div>
                                        <div style={{ fontSize: '1.125rem', fontWeight: '700', color: '#2563eb' }}>
                                            {count} ventes
                                        </div>
                                    </div>
                                ))}
                        </div>
                    </div>
                </div>
            );
        }

        // ========== FORMULAIRE SAISIE ==========
        
        function SaisieVente({ currentUser, config, onSubmit, onCancel, editingVente }) {
            const [formData, setFormData] = useState({
                nom: '', prenom: '', age: '', numeroPersonne: '',
                vente: '', rattachement: '', origine: '', contrat: '',
                dateEffet: '', chiffreAffaires: '', pna: '', jourRdv: '', commentaire: ''
            });

            useEffect(() => {
                if (editingVente) {
                    setFormData(editingVente);
                }
            }, [editingVente]);

            const rattachementOptions = useMemo(() => {
                let options = [];
                if (currentUser.type === 'commercial') {
                    options.push(currentUser.agence);
                    options = options.concat(currentUser.permanences || []);
                }
                options = options.concat(config.rattachements || []);
                return [...new Set(options)];
            }, [currentUser, config.rattachements]);

            const handleSubmit = (e) => {
                e.preventDefault();
                
                const venteData = {
                    ...formData,
                    commercial: currentUser.name
                };

                if (editingVente) {
                    venteData.id = editingVente.id;
                    venteData.dateCreation = editingVente.dateCreation;
                    venteData.dateModification = new Date().toLocaleString('fr-FR');
                } else {
                    venteData.id = Date.now().toString();
                    venteData.dateCreation = new Date().toLocaleString('fr-FR');
                }

                onSubmit(venteData);
            };

            return (
                <div className="container" style={{ paddingTop: '1.5rem' }}>
                    <div className="card">
                        <h2 style={{ fontSize: '1.25rem', fontWeight: '600', marginBottom: '1.5rem' }}>
                            {editingVente ? 'Modifier la vente' : 'Nouvelle vente'}
                        </h2>

                        <form onSubmit={handleSubmit}>
                            <div className="form-grid">
                                <div className="form-group">
                                    <label className="form-label">Nom *</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={formData.nom}
                                        onChange={(e) => setFormData({ ...formData, nom: e.target.value })}
                                        required
                                    />
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Pr√©nom *</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={formData.prenom}
                                        onChange={(e) => setFormData({ ...formData, prenom: e.target.value })}
                                        required
                                    />
                                </div>

                                <div className="form-group">
                                    <label className="form-label">√Çge</label>
                                    <input
                                        type="number"
                                        className="form-input"
                                        value={formData.age}
                                        onChange={(e) => setFormData({ ...formData, age: e.target.value })}
                                    />
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Num√©ro personne</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={formData.numeroPersonne}
                                        onChange={(e) => setFormData({ ...formData, numeroPersonne: e.target.value })}
                                    />
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Type de vente *</label>
                                    <select
                                        className="form-select"
                                        value={formData.vente}
                                        onChange={(e) => setFormData({ ...formData, vente: e.target.value })}
                                        required
                                    >
                                        <option value="">S√©lectionner</option>
                                        {(config.typesVente || []).map(type => (
                                            <option key={type} value={type}>{type}</option>
                                        ))}
                                    </select>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Rattachement *</label>
                                    <select
                                        className="form-select"
                                        value={formData.rattachement}
                                        onChange={(e) => setFormData({ ...formData, rattachement: e.target.value })}
                                        required
                                    >
                                        <option value="">S√©lectionner</option>
                                        {rattachementOptions.map(ratt => (
                                            <option key={ratt} value={ratt}>{ratt}</option>
                                        ))}
                                    </select>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Origine *</label>
                                    <select
                                        className="form-select"
                                        value={formData.origine}
                                        onChange={(e) => setFormData({ ...formData, origine: e.target.value })}
                                        required
                                    >
                                        <option value="">S√©lectionner</option>
                                        {(config.origines || []).map(origine => (
                                            <option key={origine} value={origine}>{origine}</option>
                                        ))}
                                    </select>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Contrat *</label>
                                    <select
                                        className="form-select"
                                        value={formData.contrat}
                                        onChange={(e) => setFormData({ ...formData, contrat: e.target.value })}
                                        required
                                    >
                                        <option value="">S√©lectionner</option>
                                        {(config.contrats || []).map(contrat => (
                                            <option key={contrat} value={contrat}>{contrat}</option>
                                        ))}
                                    </select>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Date effet *</label>
                                    <input
                                        type="date"
                                        className="form-input"
                                        value={formData.dateEffet}
                                        onChange={(e) => setFormData({ ...formData, dateEffet: e.target.value })}
                                        required
                                    />
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Chiffre d'affaires (‚Ç¨) *</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        className="form-input"
                                        value={formData.chiffreAffaires}
                                        onChange={(e) => setFormData({ ...formData, chiffreAffaires: e.target.value })}
                                        required
                                    />
                                </div>

                                <div className="form-group">
                                    <label className="form-label">PNA (‚Ç¨) *</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        className="form-input"
                                        value={formData.pna}
                                        onChange={(e) => setFormData({ ...formData, pna: e.target.value })}
                                        required
                                    />
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Jour du RDV</label>
                                    <input
                                        type="date"
                                        className="form-input"
                                        value={formData.jourRdv}
                                        onChange={(e) => setFormData({ ...formData, jourRdv: e.target.value })}
                                    />
                                </div>

                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                    <label className="form-label">Commentaire (facultatif)</label>
                                    <textarea
                                        className="form-input"
                                        style={{ minHeight: '80px', resize: 'vertical' }}
                                        placeholder="Notes, contexte, remarques..."
                                        value={formData.commentaire}
                                        onChange={(e) => setFormData({ ...formData, commentaire: e.target.value })}
                                    />
                                </div>
                            </div>

                            <div style={{ display: 'flex', gap: '0.75rem', marginTop: '1.5rem' }}>
                                <button type="submit" className="btn btn-primary">
                                    {editingVente ? 'Modifier la vente' : 'Enregistrer la vente'}
                                </button>
                                {editingVente && (
                                    <button type="button" className="btn btn-secondary" onClick={onCancel}>
                                        Annuler
                                    </button>
                                )}
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // ========== LISTE DES VENTES ==========
        
        function ListeVentes({ ventes, currentUser, filters, onEdit, onDelete }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [sortBy, setSortBy] = useState('dateCreation');
            const [sortOrder, setSortOrder] = useState('desc');
            const [selectedCommentVente, setSelectedCommentVente] = useState(null);
           
            const filteredAndSortedVentes = useMemo(() => {
                let filtered = ventes;

                // Recherche
                if (searchTerm.trim()) {
                    const search = searchTerm.toLowerCase().trim();
                    filtered = filtered.filter(v => 
                        (v.nom && v.nom.toLowerCase().includes(search)) ||
                        (v.prenom && v.prenom.toLowerCase().includes(search)) ||
                        (v.commercial && v.commercial.toLowerCase().includes(search)) ||
                        (v.contrat && v.contrat.toLowerCase().includes(search))
                    );
                }

                // Tri
                filtered.sort((a, b) => {
                    let aVal = a[sortBy] || '';
                    let bVal = b[sortBy] || '';

                    if (sortBy === 'chiffreAffaires' || sortBy === 'pna') {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    } else if (sortBy === 'dateCreation' || sortBy === 'jourRdv' || sortBy === 'dateEffet') {
                        aVal = new Date(aVal || 0);
                        bVal = new Date(bVal || 0);
                    } else {
                        aVal = String(aVal).toLowerCase();
                        bVal = String(bVal).toLowerCase();
                    }

                    if (aVal < bVal) return sortOrder === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });

                return filtered;
            }, [ventes, searchTerm, sortBy, sortOrder]);

            const periodeName = filters.viewMode === 'annuel' 
                ? `Ann√©e ${filters.year}`
                : `${new Date(0, filters.month - 1).toLocaleDateString('fr-FR', { month: 'long' })} ${filters.year}`;

            const canEdit = (vente) => {
                if (currentUser.type === 'admin') return true;
                if (currentUser.type === 'commercial') {
                    return vente.commercial?.toLowerCase().trim() === currentUser.name?.toLowerCase().trim();
                }
                return false;
            };

            return (
                <div className="container" style={{ paddingTop: '1.5rem' }}>
                    <div className="card">
                        <div style={{ borderBottom: '1px solid #e5e7eb', paddingBottom: '1rem', marginBottom: '1rem' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                <div>
                                    <h2 style={{ fontSize: '1.25rem', fontWeight: '600' }}>
                                        {currentUser.type === 'commercial' ? 'Mes ventes' : 'Liste des ventes'} ({filteredAndSortedVentes.length})
                                    </h2>
                                    <p style={{ fontSize: '0.875rem', color: '#6b7280', marginTop: '0.25rem' }}>
                                        P√©riode : {periodeName}
                                    </p>
                                </div>

                                <div style={{ display: 'flex', gap: '0.75rem', alignItems: 'center' }}>
                                    <input
                                        type="text"
                                        placeholder="Rechercher..."
                                        className="form-input"
                                        style={{ width: '200px' }}
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />

                                    <select 
                                        className="form-select"
                                        value={sortBy}
                                        onChange={(e) => setSortBy(e.target.value)}
                                    >
                                        <option value="dateCreation">Date cr√©ation</option>
                                        <option value="nom">Nom client</option>
                                        <option value="chiffreAffaires">Chiffre d'affaires</option>
                                        <option value="pna">PNA</option>
                                        <option value="dateEffet">Date effet</option>
                                    </select>

                                    <button
                                        className="btn btn-secondary"
                                        style={{ padding: '0.5rem' }}
                                        onClick={() => setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')}
                                    >
                                        {sortOrder === 'asc' ? '‚Üë' : '‚Üì'}
                                    </button>
                                </div>
                            </div>
                        </div>

                        {filteredAndSortedVentes.length === 0 ? (
                            <div style={{ padding: '2rem', textAlign: 'center', color: '#6b7280' }}>
                                <div style={{ fontSize: '1.125rem', marginBottom: '0.5rem' }}>
                                    Aucune vente pour cette p√©riode
                                </div>
                                <div style={{ fontSize: '0.875rem' }}>
                                    {searchTerm ? 'Essayez une autre recherche' : 'Cliquez sur "Nouvelle vente" pour commencer'}
                                </div>
                            </div>
                        ) : (
                            <div style={{ overflowX: 'auto' }}>
                                <table className="table">
                                    <thead>
                                        <tr>
                                            {currentUser.type === 'admin' && <th>Commercial</th>}
                                            <th>Client</th>
                                            <th>Contrat</th>
                                            <th>Type</th>
                                            <th>Rattachement</th>
                                            <th>CA (‚Ç¨)</th>
                                            <th>PNA (‚Ç¨)</th>
                                            <th>Date effet</th>
                                            <th style={{ textAlign: 'right' }}>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredAndSortedVentes.map(vente => (
                                            <tr key={vente.id}>
                                                {currentUser.type === 'admin' && (
                                                    <td style={{ fontWeight: '500' }}>{vente.commercial}</td>
                                                )}
                                                <td>
                                                    {vente.nom} {vente.prenom}
                                                   {vente.commentaire && (
                                               <span 
                                                 style={{ cursor: 'pointer', color: '#2563eb', marginLeft: '0.5rem', fontSize: '1.1rem', transition: 'transform 0.2s' }}
                                                 onClick={() => setSelectedCommentVente(vente)}
                                                 onMouseEnter={(e) => e.target.style.transform = 'scale(1.2)'}
                                                 onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                                                 title="Voir le commentaire"
                                               >
                                                  üí¨
                                               </span>
                                               )}
                                                </td>
                                                <td>{vente.contrat}</td>
                                                <td>
                                                    <span className={`badge ${vente.vente === 'T√©l' ? 'badge-blue' : 'badge-green'}`}>
                                                        {vente.vente}
                                                    </span>
                                                </td>
                                                <td>{vente.rattachement}</td>
                                                <td style={{ fontWeight: '500', color: '#059669' }}>
                                                    {parseFloat(vente.chiffreAffaires || 0).toFixed(2)}
                                                </td>
                                                <td style={{ fontWeight: '500', color: '#7c3aed' }}>
                                                    {parseFloat(vente.pna || 0).toFixed(2)}
                                                </td>
                                                <td>{vente.dateEffet}</td>
                                                <td style={{ textAlign: 'right' }}>
                                                    {canEdit(vente) && (
                                                        <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '0.5rem' }}>
                                                            <button
                                                                className="btn btn-secondary"
                                                                style={{ padding: '0.25rem 0.5rem', fontSize: '0.75rem' }}
                                                                onClick={() => onEdit(vente)}
                                                                title="Modifier"
                                                            >
                                                                ‚úèÔ∏è
                                                            </button>
                                                            <button
                                                                className="btn btn-danger"
                                                                style={{ padding: '0.25rem 0.5rem', fontSize: '0.75rem' }}
                                                                onClick={() => onDelete(vente.id)}
                                                                title="Supprimer"
                                                            >
                                                                üóëÔ∏è
                                                            </button>
                                                        </div>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ========== PAGE GESTION (Admin) ==========
        
        function GestionPage({ config, onUpdateConfig }) {
            const [showContractForm, setShowContractForm] = useState(false);
            const [showTypeVenteForm, setShowTypeVenteForm] = useState(false);
            const [showOrigineForm, setShowOrigineForm] = useState(false);
            const [showRattachementForm, setShowRattachementForm] = useState(false);

            const [newContract, setNewContract] = useState('');
            const [newTypeVente, setNewTypeVente] = useState('');
            const [newOrigine, setNewOrigine] = useState('');
            const [newRattachement, setNewRattachement] = useState('');

            const handleAddContract = async () => {
                if (!newContract.trim()) {
                    alert('Veuillez saisir un nom de contrat');
                    return;
                }
                if (config.contrats.includes(newContract.trim())) {
                    alert('Ce contrat existe d√©j√†');
                    return;
                }

                const newContrats = [...config.contrats, newContract.trim()];
                await onUpdateConfig('contrats', newContrats);
                setNewContract('');
                setShowContractForm(false);
            };

            const handleDeleteContract = async (contract) => {
                const newContrats = config.contrats.filter(c => c !== contract);
                await onUpdateConfig('contrats', newContrats);
            };

            const handleAddTypeVente = async () => {
                if (!newTypeVente.trim()) {
                    alert('Veuillez saisir un nom de type de vente');
                    return;
                }
                if (config.typesVente.includes(newTypeVente.trim())) {
                    alert('Ce type de vente existe d√©j√†');
                    return;
                }

                const newTypesVente = [...config.typesVente, newTypeVente.trim()];
                await onUpdateConfig('typesVente', newTypesVente);
                setNewTypeVente('');
                setShowTypeVenteForm(false);
            };

            const handleDeleteTypeVente = async (type) => {
                const newTypesVente = config.typesVente.filter(t => t !== type);
                await onUpdateConfig('typesVente', newTypesVente);
            };

            const handleAddOrigine = async () => {
                if (!newOrigine.trim()) {
                    alert('Veuillez saisir un nom d\'origine');
                    return;
                }
                if (config.origines.includes(newOrigine.trim())) {
                    alert('Cette origine existe d√©j√†');
                    return;
                }

                const newOrigines = [...config.origines, newOrigine.trim()];
                await onUpdateConfig('origines', newOrigines);
                setNewOrigine('');
                setShowOrigineForm(false);
            };

            const handleDeleteOrigine = async (origine) => {
                const newOrigines = config.origines.filter(o => o !== origine);
                await onUpdateConfig('origines', newOrigines);
            };

            const handleAddRattachement = async () => {
                if (!newRattachement.trim()) {
                    alert('Veuillez saisir un nom de rattachement');
                    return;
                }
                if (config.rattachements.includes(newRattachement.trim())) {
                    alert('Ce rattachement existe d√©j√†');
                    return;
                }

                const newRattachements = [...config.rattachements, newRattachement.trim()];
                await onUpdateConfig('rattachements', newRattachements);
                setNewRattachement('');
                setShowRattachementForm(false);
            };

            const handleDeleteRattachement = async (ratt) => {
                const newRattachements = config.rattachements.filter(r => r !== ratt);
                await onUpdateConfig('rattachements', newRattachements);
            };

            return (
                <div className="container" style={{ paddingTop: '1.5rem' }}>
                    {/* Gestion des Contrats */}
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                            <h3 style={{ fontSize: '1.125rem', fontWeight: '600' }}>
                                Gestion des Types de Contrats
                            </h3>
                            <button 
                                className="btn btn-primary"
                                onClick={() => setShowContractForm(!showContractForm)}
                            >
                                ‚ûï Ajouter un contrat
                            </button>
                        </div>

                        {showContractForm && (
                            <div style={{ marginBottom: '1.5rem', padding: '1rem', background: '#f9fafb', borderRadius: '0.5rem' }}>
                                <div style={{ display: 'flex', gap: '0.75rem' }}>
                                    <input
                                        type="text"
                                        placeholder="Nom du nouveau contrat"
                                        className="form-input"
                                        style={{ flex: 1 }}
                                        value={newContract}
                                        onChange={(e) => setNewContract(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleAddContract()}
                                    />
                                    <button className="btn btn-success" onClick={handleAddContract}>
                                        Ajouter
                                    </button>
                                    <button className="btn btn-secondary" onClick={() => {
                                        setShowContractForm(false);
                                        setNewContract('');
                                    }}>
                                        Annuler
                                    </button>
                                </div>
                            </div>
                        )}

                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '0.75rem' }}>
                            {config.contrats.map(contrat => (
                                <div key={contrat} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0.75rem', background: '#f9fafb', borderRadius: '0.5rem' }}>
                                    <span style={{ fontSize: '0.875rem', flex: 1 }}>{contrat}</span>
                                    <button
                                        className="btn btn-danger"
                                        style={{ padding: '0.25rem 0.5rem', fontSize: '0.75rem' }}
                                        onClick={() => {
                                            if (window.confirm(`Supprimer le contrat "${contrat}" ?`)) {
                                                handleDeleteContract(contrat);
                                            }
                                        }}
                                        title="Supprimer ce contrat"
                                    >
                                        üóëÔ∏è
                                    </button>
                                </div>
                            ))}
                        </div>

                        {config.contrats.length === 0 && (
                            <p style={{ textAlign: 'center', color: '#6b7280', padding: '2rem' }}>
                                Aucun contrat configur√©
                            </p>
                        )}
                    </div>

                    {/* Gestion des Types de Vente */}
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                            <h3 style={{ fontSize: '1.125rem', fontWeight: '600' }}>
                                Gestion des Types de Vente
                            </h3>
                            <button 
                                className="btn btn-primary"
                                onClick={() => setShowTypeVenteForm(!showTypeVenteForm)}
                            >
                                ‚ûï Ajouter un type
                            </button>
                        </div>

                        {showTypeVenteForm && (
                            <div style={{ marginBottom: '1.5rem', padding: '1rem', background: '#f9fafb', borderRadius: '0.5rem' }}>
                                <div style={{ display: 'flex', gap: '0.75rem' }}>
                                    <input
                                        type="text"
                                        placeholder="Nom du nouveau type de vente"
                                        className="form-input"
                                        style={{ flex: 1 }}
                                        value={newTypeVente}
                                        onChange={(e) => setNewTypeVente(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleAddTypeVente()}
                                    />
                                    <button className="btn btn-success" onClick={handleAddTypeVente}>
                                        Ajouter
                                    </button>
                                    <button className="btn btn-secondary" onClick={() => {
                                        setShowTypeVenteForm(false);
                                        setNewTypeVente('');
                                    }}>
                                        Annuler
                                    </button>
                                </div>
                            </div>
                        )}

                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '0.75rem' }}>
                            {config.typesVente.map(type => (
                                <div key={type} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0.75rem', background: '#f9fafb', borderRadius: '0.5rem' }}>
                                    <span style={{ fontSize: '0.875rem', flex: 1 }}>{type}</span>
                                    <button
                                        className="btn btn-danger"
                                        style={{ padding: '0.25rem 0.5rem', fontSize: '0.75rem' }}
                                        onClick={() => {
                                            if (window.confirm(`Supprimer le type de vente "${type}" ?`)) {
                                                handleDeleteTypeVente(type);
                                            }
                                        }}
                                        title="Supprimer ce type"
                                    >
                                        üóëÔ∏è
                                    </button>
                                </div>
                            ))}
                        </div>

                        {config.typesVente.length === 0 && (
                            <p style={{ textAlign: 'center', color: '#6b7280', padding: '2rem' }}>
                                Aucun type de vente configur√©
                            </p>
                        )}
                    </div>

                    {/* Gestion des Origines */}
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                            <h3 style={{ fontSize: '1.125rem', fontWeight: '600' }}>
                                Gestion des Origines
                            </h3>
                            <button 
                                className="btn btn-primary"
                                onClick={() => setShowOrigineForm(!showOrigineForm)}
                            >
                                ‚ûï Ajouter une origine
                            </button>
                        </div>

                        {showOrigineForm && (
                            <div style={{ marginBottom: '1.5rem', padding: '1rem', background: '#f9fafb', borderRadius: '0.5rem' }}>
                                <div style={{ display: 'flex', gap: '0.75rem' }}>
                                    <input
                                        type="text"
                                        placeholder="Nom de la nouvelle origine"
                                        className="form-input"
                                        style={{ flex: 1 }}
                                        value={newOrigine}
                                        onChange={(e) => setNewOrigine(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleAddOrigine()}
                                    />
                                    <button className="btn btn-success" onClick={handleAddOrigine}>
                                        Ajouter
                                    </button>
                                    <button className="btn btn-secondary" onClick={() => {
                                        setShowOrigineForm(false);
                                        setNewOrigine('');
                                    }}>
                                        Annuler
                                    </button>
                                </div>
                            </div>
                        )}

                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '0.75rem' }}>
                            {config.origines.map(origine => (
                                <div key={origine} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0.75rem', background: '#f9fafb', borderRadius: '0.5rem' }}>
                                    <span style={{ fontSize: '0.875rem', flex: 1 }}>{origine}</span>
                                    <button
                                        className="btn btn-danger"
                                        style={{ padding: '0.25rem 0.5rem', fontSize: '0.75rem' }}
                                        onClick={() => {
                                            if (window.confirm(`Supprimer l'origine "${origine}" ?`)) {
                                                handleDeleteOrigine(origine);
                                            }
                                        }}
                                        title="Supprimer cette origine"
                                    >
                                        üóëÔ∏è
                                    </button>
                                </div>
                            ))}
                        </div>

                        {config.origines.length === 0 && (
                            <p style={{ textAlign: 'center', color: '#6b7280', padding: '2rem' }}>
                                Aucune origine configur√©e
                            </p>
                        )}
                    </div>

                    {/* Gestion des Rattachements */}
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                            <h3 style={{ fontSize: '1.125rem', fontWeight: '600' }}>
                                Gestion des Rattachements
                            </h3>
                            <button 
                                className="btn btn-primary"
                                onClick={() => setShowRattachementForm(!showRattachementForm)}
                            >
                                ‚ûï Ajouter un rattachement
                            </button>
                        </div>

                        <p style={{ fontSize: '0.875rem', color: '#6b7280', marginBottom: '1rem' }}>
                            Les agences et permanences des commerciaux sont automatiquement disponibles. Ajoutez ici des rattachements suppl√©mentaires.
                        </p>

                        {showRattachementForm && (
                            <div style={{ marginBottom: '1.5rem', padding: '1rem', background: '#f9fafb', borderRadius: '0.5rem' }}>
                                <div style={{ display: 'flex', gap: '0.75rem' }}>
                                    <input
                                        type="text"
                                        placeholder="Nom du nouveau rattachement"
                                        className="form-input"
                                        style={{ flex: 1 }}
                                        value={newRattachement}
                                        onChange={(e) => setNewRattachement(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleAddRattachement()}
                                    />
                                    <button className="btn btn-success" onClick={handleAddRattachement}>
                                        Ajouter
                                    </button>
                                    <button className="btn btn-secondary" onClick={() => {
                                        setShowRattachementForm(false);
                                        setNewRattachement('');
                                    }}>
                                        Annuler
                                    </button>
                                </div>
                            </div>
                        )}

                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '0.75rem' }}>
                            {config.rattachements.map(ratt => (
                                <div key={ratt} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0.75rem', background: '#f9fafb', borderRadius: '0.5rem' }}>
                                    <span style={{ fontSize: '0.875rem', flex: 1 }}>{ratt}</span>
                                    <button
                                        className="btn btn-danger"
                                        style={{ padding: '0.25rem 0.5rem', fontSize: '0.75rem' }}
                                        onClick={() => {
                                            if (window.confirm(`Supprimer le rattachement "${ratt}" ?`)) {
                                                handleDeleteRattachement(ratt);
                                            }
                                        }}
                                        title="Supprimer ce rattachement"
                                    >
                                        üóëÔ∏è
                                    </button>
                                </div>
                            ))}
                        </div>

                        {config.rattachements.length === 0 && (
                            <p style={{ textAlign: 'center', color: '#6b7280', padding: '2rem' }}>
                                Aucun rattachement personnalis√© configur√©
                            </p>
                        )}
                    </div>
                </div>
            );
        }

        // ========== APPLICATION PRINCIPALE ==========
        
        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [isAuthenticating, setIsAuthenticating] = useState(true);
            const [ventes, setVentes] = useState([]);
            const [config, setConfig] = useState({
                contrats: [],
                typesVente: [],
                origines: [],
                rattachements: []
            });
            const [currentView, setCurrentView] = useState('dashboard');
            const [filters, setFilters] = useState({
                commercial: 'tous',
                month: new Date().getMonth() + 1,
                year: new Date().getFullYear(),
                viewMode: 'mensuel'
            });
            const [notification, setNotification] = useState(null);
            const [loading, setLoading] = useState(false);
            const [confirmModal, setConfirmModal] = useState(null);
            const [editingVente, setEditingVente] = useState(null);

            // Authentification
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        try {
                            const userRolesSnapshot = await db.collection('userRoles').get();
                            let userRole = null;
                            let allUsers = {};

                            userRolesSnapshot.forEach((doc) => {
                                const userData = doc.data();
                                allUsers[userData.email] = userData;
                                
                                if (userData.email === user.email) {
                                    userRole = userData;
                                }
                            });

                            if (userRole) {
                                setCurrentUser({
                                    email: user.email,
                                    uid: user.uid,
                                    ...userRole,
                                    allUsers
                                });
                            } else {
                                setCurrentUser(null);
                                showNotification('Acc√®s non autoris√©', 'error');
                                await auth.signOut();
                            }
                        } catch (error) {
                            console.error('Erreur r√©cup√©ration r√¥les:', error);
                            setCurrentUser(null);
                        }
                    } else {
                        setCurrentUser(null);
                    }

                    setIsAuthenticating(false);
                });

                return () => unsubscribe();
            }, []);

            // Charger les ventes et config
            useEffect(() => {
                if (!currentUser) return;

                // √âcoute en temps r√©el des ventes
                const unsubscribeVentes = db.collection('ventes').onSnapshot((snapshot) => {
                    const firebaseVentes = [];
                    snapshot.forEach((doc) => {
                        firebaseVentes.push({ id: doc.id, ...doc.data() });
                    });
                    setVentes(firebaseVentes);
                });

                // √âcoute en temps r√©el de la config
                const unsubscribeConfig = db.collection('config').onSnapshot((snapshot) => {
                    const newConfig = {
                        contrats: [],
                        typesVente: [],
                        origines: [],
                        rattachements: []
                    };

                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.type === 'contrat') newConfig.contrats.push(data.value);
                        else if (data.type === 'typeVente') newConfig.typesVente.push(data.value);
                        else if (data.type === 'origine') newConfig.origines.push(data.value);
                        else if (data.type === 'rattachement') newConfig.rattachements.push(data.value);
                    });

                    setConfig(newConfig);
                });

                return () => {
                    unsubscribeVentes();
                    unsubscribeConfig();
                };
            }, [currentUser]);

            // Filtrer les ventes
            const filteredVentes = useMemo(() => {
                let filtered = ventes;

                // Filtre par commercial
                if (currentUser?.type === 'commercial') {
                    filtered = filtered.filter(v => v.commercial === currentUser.name);
                } else if (currentUser?.type === 'admin' && filters.commercial !== 'tous') {
                    filtered = filtered.filter(v => v.commercial === filters.commercial);
                }

                // Filtre par p√©riode
                filtered = filtered.filter(v => {
                    if (!v.jourRdv) return false;
                    const date = new Date(v.jourRdv);
                    if (filters.viewMode === 'annuel') {
                        return date.getFullYear() === filters.year;
                    } else {
                        return date.getMonth() + 1 === filters.month && date.getFullYear() === filters.year;
                    }
                });

                return filtered;
            }, [ventes, currentUser, filters]);

            const showNotification = (message, type = 'info') => {
                setNotification({ message, type });
            };

            const handleLogout = async () => {
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error('Erreur d√©connexion:', error);
                }
            };

            const handleSubmitVente = async (venteData) => {
                setLoading(true);

                try {
                    if (editingVente) {
                        // Mise √† jour
                        const { id, ...dataToUpdate } = venteData;
                        await db.collection('ventes').doc(venteData.id).update(dataToUpdate);
                        showNotification('Vente modifi√©e avec succ√®s', 'success');
                    } else {
                        // Cr√©ation
                        const { id, ...dataToSave } = venteData;
                        await db.collection('ventes').add(dataToSave);
                        showNotification('Vente ajout√©e avec succ√®s', 'success');
                    }

                    setEditingVente(null);
                    setCurrentView('liste');
                } catch (error) {
                    console.error('Erreur sauvegarde:', error);
                    showNotification('Erreur lors de la sauvegarde', 'error');
                }

                setLoading(false);
            };

            const handleEditVente = (vente) => {
                setEditingVente(vente);
                setCurrentView('saisie');
            };

            const handleDeleteVente = (venteId) => {
                setConfirmModal({
                    title: 'Supprimer la vente',
                    message: '√ätes-vous s√ªr de vouloir supprimer d√©finitivement cette vente ? Cette action est irr√©versible.',
                    onConfirm: async () => {
                        setLoading(true);
                        
                        try {
                            await db.collection('ventes').doc(venteId).delete();
                            showNotification('Vente supprim√©e avec succ√®s', 'success');
                        } catch (error) {
                            console.error('Erreur suppression:', error);
                            showNotification('Erreur lors de la suppression', 'error');
                        }

                        setLoading(false);
                        setConfirmModal(null);
                    },
                    onCancel: () => setConfirmModal(null)
                });
            };

            const handleUpdateConfig = async (configType, newValues) => {
                setLoading(true);

                try {
                    // Supprimer les anciennes valeurs de ce type
                    const configSnapshot = await db.collection('config').get();
                    const deletePromises = [];
                    
                    configSnapshot.forEach((docSnap) => {
                        const data = docSnap.data();
                        if (data.type === configType) {
                            deletePromises.push(docSnap.ref.delete());
                        }
                    });

                    await Promise.all(deletePromises);

                    // Ajouter les nouvelles valeurs
                    const addPromises = newValues.map(value => 
                        db.collection('config').add({
                            type: configType,
                            value: value,
                            dateCreation: new Date().toISOString()
                        })
                    );

                    await Promise.all(addPromises);

                    showNotification('Configuration mise √† jour', 'success');
                } catch (error) {
                    console.error('Erreur mise √† jour config:', error);
                    showNotification('Erreur lors de la mise √† jour', 'error');
                }

                setLoading(false);
            };

            const handleExportCSV = () => {
                if (filteredVentes.length === 0) {
                    showNotification('Aucune vente √† exporter', 'info');
                    return;
                }

                const headers = [
                    'Commercial', 'Nom', 'Pr√©nom', '√Çge', 'Num√©ro personne', 'Vente', 'Rattachement',
                    'Origine', 'Contrat', 'Date effet', 'Chiffre d\'affaires', 'PNA', 'Jour du rdv'
                ];

                let csvContent = headers.join(';') + '\n';

                filteredVentes.forEach(vente => {
                    const row = [
                        vente.commercial || '', vente.nom || '', vente.prenom || '', vente.age || '', 
                        vente.numeroPersonne || '', vente.vente || '', vente.rattachement || '', 
                        vente.origine || '', vente.contrat || '', vente.dateEffet || '',
                        vente.chiffreAffaires || '', vente.pna || '', vente.jourRdv || ''
                    ];
                    csvContent += row.join(';') + '\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.href = url;
                
                const filename = `ventes_${
                    currentUser.type === 'commercial' ? currentUser.name : 
                    (filters.commercial !== 'tous' ? filters.commercial : 'toutes')
                }_${filters.viewMode === 'annuel' ? filters.year : `${filters.month}-${filters.year}`}.csv`;
                
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showNotification('Export CSV cr√©√© avec succ√®s', 'success');
            };

            if (isAuthenticating) {
                return (
                    <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <div style={{ textAlign: 'center' }}>
                            <div style={{ fontSize: '1.5rem', marginBottom: '1rem' }}>üîÑ Chargement...</div>
                            <div style={{ color: '#6b7280' }}>V√©rification de l'authentification</div>
                        </div>
                    </div>
                );
            }

            if (!currentUser) {
                return <LoginPage />;
            }

            return (
                <>
                    <Header
                        currentUser={currentUser}
                        currentView={currentView}
                        setCurrentView={(view) => {
                            setCurrentView(view);
                            if (view !== 'saisie') setEditingVente(null);
                        }}
                        filters={filters}
                        setFilters={setFilters}
                        onLogout={handleLogout}
                        onExport={handleExportCSV}
                        ventesCount={filteredVentes.length}
                    />

                    {currentView === 'dashboard' && (
                        <Dashboard ventes={filteredVentes} currentUser={currentUser} />
                    )}

                    {currentView === 'saisie' && currentUser.type === 'commercial' && (
                        <SaisieVente
                            currentUser={currentUser}
                            config={config}
                            onSubmit={handleSubmitVente}
                            onCancel={() => {
                                setEditingVente(null);
                                setCurrentView('liste');
                            }}
                            editingVente={editingVente}
                        />
                    )}

                    {currentView === 'liste' && (
                        <ListeVentes
                            ventes={filteredVentes}
                            currentUser={currentUser}
                            filters={filters}
                            onEdit={handleEditVente}
                            onDelete={handleDeleteVente}
                        />
                    }))}
                
                {selectedCommentVente && (
                    <CommentModal 
                        vente={selectedCommentVente} 
                        onClose={() => setSelectedCommentVente(null)}
                    />
                )}
            </div>
        );
    }

                    {currentView === 'gestion' && currentUser.type === 'admin' && (
                        <GestionPage
                            config={config}
                            onUpdateConfig={handleUpdateConfig}
                        />
                    )}

                    {notification && (
                        <Notification
                            message={notification.message}
                            type={notification.type}
                            onClose={() => setNotification(null)}
                        />
                    )}

                    {loading && <LoadingOverlay />}

                    {confirmModal && (
                        <ConfirmModal
                            title={confirmModal.title}
                            message={confirmModal.message}
                            onConfirm={confirmModal.onConfirm}
                            onCancel={confirmModal.onCancel}
                        />
                    )}
                </>
            );
        }

        // Rendu de l'application
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>

    <!-- Firebase SDK (n√©cessaire pour React) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</body>
</html>
